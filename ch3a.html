<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.8.27">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>5&nbsp; data acquisition – Introduction to Bibliographic Data Science</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./ch3b.html" rel="next">
<link href="./ch2b.html" rel="prev">
<link href="./images/favicon.png" rel="icon" type="image/png">
<script src="site_libs/quarto-html/quarto.js" type="module"></script>
<script src="site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="site_libs/quarto-html/axe/axe-check.js" type="module"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-ed96de9b727972fe78a7b5d16c58bf87.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap-0dd2bd5de344125cf763a379ddc3eb04.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


</head>

<body class="nav-sidebar floating quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./ch3a.html">The data analysis workflow</a></li><li class="breadcrumb-item"><a href="./ch3a.html"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">data acquisition</span></a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">Introduction to Bibliographic Data Science</a> 
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Preface</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./introduction.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Introduction</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./ch1.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">The objective of bibliographic data science</span></span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true">
 <span class="menu-text">Theoretical models</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./ch2a.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Scientific theories and models</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./ch2b.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Cultural heritage data models</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true">
 <span class="menu-text">The data analysis workflow</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./ch3a.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">data acquisition</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./ch3b.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">data validation</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./ch3c.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">preprocessing</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./ch3d.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">data harmonisation</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./ch3e.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">data analysis</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./ch3f.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">dissemination</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./ch4.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">After the research</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./references.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">References</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="true">
 <span class="menu-text">Appendices</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./ap1.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">A</span>&nbsp; <span class="chapter-title">Books</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./ap2.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">B</span>&nbsp; <span class="chapter-title">Journals</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./ap3.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">C</span>&nbsp; <span class="chapter-title">Conferences</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./ap4.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">D</span>&nbsp; <span class="chapter-title">Data sources</span></span></a>
  </div>
</li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#creating-directories" id="toc-creating-directories" class="nav-link active" data-scroll-target="#creating-directories"><span class="header-section-number">5.1</span> Creating directories</a></li>
  <li><a href="#download-a-marcxml-file" id="toc-download-a-marcxml-file" class="nav-link" data-scroll-target="#download-a-marcxml-file"><span class="header-section-number">5.2</span> Download a MARCXML file</a></li>
  <li><a href="#apis-to-retrieve-records" id="toc-apis-to-retrieve-records" class="nav-link" data-scroll-target="#apis-to-retrieve-records"><span class="header-section-number">5.3</span> APIs to retrieve records</a>
  <ul class="collapse">
  <li><a href="#oai-pmh" id="toc-oai-pmh" class="nav-link" data-scroll-target="#oai-pmh"><span class="header-section-number">5.3.1</span> OAI-PMH</a></li>
  </ul></li>
  <li><a href="#download-an-sql-file" id="toc-download-an-sql-file" class="nav-link" data-scroll-target="#download-an-sql-file"><span class="header-section-number">5.4</span> Download an SQL file</a>
  <ul class="collapse">
  <li><a href="#import-btee-to-the-database" id="toc-import-btee-to-the-database" class="nav-link" data-scroll-target="#import-btee-to-the-database"><span class="header-section-number">5.4.1</span> import BTEE to the database</a></li>
  </ul></li>
  <li><a href="#web-scraping" id="toc-web-scraping" class="nav-link" data-scroll-target="#web-scraping"><span class="header-section-number">5.5</span> Web scraping</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default"><nav class="quarto-page-breadcrumbs quarto-title-breadcrumbs d-none d-lg-block" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./ch3a.html">The data analysis workflow</a></li><li class="breadcrumb-item"><a href="./ch3a.html"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">data acquisition</span></a></li></ol></nav>
<div class="quarto-title">
<h1 class="title"><span id="sec-ch3a" class="quarto-section-identifier"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">data acquisition</span></span></h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<p>abstract: Main types of bibliographic data and data sources (library catalogs, citation databases, research data repositories, historical sources). Methods of data acquisition (standards, application programming interfaces, and tools), information about data structure (metadata schemas and serialization formats), terms of use.</p>
<p>Digital data can be retrieved in three main methods. The most convenient option is for these to be available as downloadable files (e.g., as reusable research data), however this type of data sharing is relatively rare. It is more common for data sources to be accessed through some kind of application programming interface. Various applications are available for the most common interfaces (OAI-PMH, Z39.50, SRW/SRU, SPARQL), so programming is not necessarily required, but time must be set aside to study the institution-specific settings and parameters of the interfaces. Finally, it is often the case that no previous opportunity was available. At this point, we extract the data from the HTML source of the website, assuming that the typographical formatting consistently indicates certain semantic elements17 – but in this case, it is worth consulting with the website operator to see if there are any other options not documented on the site. Whichever solution you choose, make sure that the data license allows reuse. After downloading the data, the first step is to import it. Programming libraries supporting various bibliographic formats are available; for MARC21, for example, there are ones for Java, Python, Go, JavaScript, R, PHP, and other programming languages. In this textbook we will work with Python, but the code could be adapted to other programming languages.</p>
<p>There are four main types of data sources for library history research:</p>
<ol type="1">
<li>library catalogs (e.g., national libraries or general purpose union catalogs, as well as catalogs of specifically old books, such as the VD16, VD17 and VD18 series that register 16th, 17th, and 18th century German books, their Italian counterpart EDIT16, and the Heritage of the Printed Book database),</li>
<li>digital library catalogs (Europeana, Gallica, German Digital Library, Hungarian Electronic Library, HathiTrust),</li>
<li>citation databases and research data repositories (DataCite, Zenodo, OpenAlex, Open Citation), and finally</li>
<li>databases of digitized (book) historical sources (the database of the Société Typographique de Neuchâtel, the database of 18th-century Dutch auction book catalogs MEDIATE, or the no defunct Eruditio in Hungary).</li>
</ol>
<section id="creating-directories" class="level2" data-number="5.1">
<h2 data-number="5.1" class="anchored" data-anchor-id="creating-directories"><span class="header-section-number">5.1</span> Creating directories</h2>
<p>In this textbook we will work with different directories:</p>
<ul>
<li><code>data</code>: the data we created</li>
<li><code>raw-data</code>: our original data sources downloaded from data providers’ sites</li>
<li><code>plots</code>: the output of data visualization</li>
</ul>
<p>The first programming task is to create these directories. To create them we use the <code>os</code> Python library that provides standard operating system functions, such as <code>makedirs</code> that creates a directory.</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="annotated-cell-1"><pre class="sourceCode python code-annotation-code code-with-copy code-annotated"><code class="sourceCode python"><a class="code-annotation-anchor" data-target-cell="annotated-cell-1" data-target-annotation="1" onclick="event.preventDefault();">1</a><span id="annotated-cell-1-1" class="code-annotation-target"><a href="#annotated-cell-1-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="annotated-cell-1-2"><a href="#annotated-cell-1-2" aria-hidden="true" tabindex="-1"></a></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-1" data-target-annotation="2" onclick="event.preventDefault();">2</a><span id="annotated-cell-1-3" class="code-annotation-target"><a href="#annotated-cell-1-3" aria-hidden="true" tabindex="-1"></a>directories <span class="op">=</span> [<span class="st">'data'</span>, <span class="st">'raw-data'</span>, <span class="st">'plots'</span>]</span>
<span id="annotated-cell-1-4"><a href="#annotated-cell-1-4" aria-hidden="true" tabindex="-1"></a></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-1" data-target-annotation="3" onclick="event.preventDefault();">3</a><span id="annotated-cell-1-5" class="code-annotation-target"><a href="#annotated-cell-1-5" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> directory <span class="kw">in</span> directories:</span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-1" data-target-annotation="4" onclick="event.preventDefault();">4</a><span id="annotated-cell-1-6" class="code-annotation-target"><a href="#annotated-cell-1-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> os.path.exists(directory):</span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-1" data-target-annotation="5" onclick="event.preventDefault();">5</a><span id="annotated-cell-1-7" class="code-annotation-target"><a href="#annotated-cell-1-7" aria-hidden="true" tabindex="-1"></a>        os.makedirs(directory)</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-1" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-1" data-code-lines="1" data-code-annotation="1">imports the <code>os</code> library</span>
</dd>
<dt data-target-cell="annotated-cell-1" data-target-annotation="2">2</dt>
<dd>
<span data-code-cell="annotated-cell-1" data-code-lines="3" data-code-annotation="2">creates a list with three strings, the names of the directories</span>
</dd>
<dt data-target-cell="annotated-cell-1" data-target-annotation="3">3</dt>
<dd>
<span data-code-cell="annotated-cell-1" data-code-lines="5" data-code-annotation="3">iterates the directories one by one. In each iteration the name of the current directory will be stored in the variable <code>directory</code></span>
</dd>
<dt data-target-cell="annotated-cell-1" data-target-annotation="4">4</dt>
<dd>
<span data-code-cell="annotated-cell-1" data-code-lines="6" data-code-annotation="4">checks if the directory does not exist. If it exists the script skips the directory and takes the next one. If it doesn’t exist, it continue with the next command</span>
</dd>
<dt data-target-cell="annotated-cell-1" data-target-annotation="5">5</dt>
<dd>
<span data-code-cell="annotated-cell-1" data-code-lines="7" data-code-annotation="5">creates the directory (due to the test in the previous line only if it doesn’t exist already)</span>
</dd>
</dl>
<p>The code of this section is available at <code>scripts/ch3a-create-directories.py</code> of the repository.</p>
</section>
<section id="download-a-marcxml-file" class="level2" data-number="5.2">
<h2 data-number="5.2" class="anchored" data-anchor-id="download-a-marcxml-file"><span class="header-section-number">5.2</span> Download a MARCXML file</h2>
<p>You can find a list of downloadable library catalogues <a href="https://github.com/pkiraly/qa-catalogue#datasources">ḣere</a>. Now download a relatively small file with MARC records of the Latvian National Bibliography (2014-2023) provided by the <a href="https://dati.lnb.lv/">Open Data Portal</a> of the National Library of Latvia. The files are compressed with zip, so in order to use them we should extract them, and because the zip file contains a <code>data</code> subdirectory, we rename that to <code>lnb</code> (after the domain name of the National Library of Latvia).</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="annotated-cell-2"><pre class="sourceCode python code-annotation-code code-with-copy code-annotated"><code class="sourceCode python"><a class="code-annotation-anchor" data-target-cell="annotated-cell-2" data-target-annotation="1" onclick="event.preventDefault();">1</a><span id="annotated-cell-2-1" class="code-annotation-target"><a href="#annotated-cell-2-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> urllib.request</span>
<span id="annotated-cell-2-2"><a href="#annotated-cell-2-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> zipfile</span>
<span id="annotated-cell-2-3"><a href="#annotated-cell-2-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="annotated-cell-2-4"><a href="#annotated-cell-2-4" aria-hidden="true" tabindex="-1"></a></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-2" data-target-annotation="2" onclick="event.preventDefault();">2</a><span id="annotated-cell-2-5" class="code-annotation-target"><a href="#annotated-cell-2-5" aria-hidden="true" tabindex="-1"></a>url <span class="op">=</span> <span class="st">'https://dati.lnb.lv/files/natl_bibliography-2014-2023-marc.zip'</span></span>
<span id="annotated-cell-2-6"><a href="#annotated-cell-2-6" aria-hidden="true" tabindex="-1"></a>target_dir <span class="op">=</span> <span class="st">'raw-data'</span></span>
<span id="annotated-cell-2-7"><a href="#annotated-cell-2-7" aria-hidden="true" tabindex="-1"></a>target_file <span class="op">=</span> target_dir <span class="op">+</span> <span class="st">'/lnb-natl_bibliography-2014-2023-marc.zip'</span></span>
<span id="annotated-cell-2-8"><a href="#annotated-cell-2-8" aria-hidden="true" tabindex="-1"></a></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-2" data-target-annotation="3" onclick="event.preventDefault();">3</a><span id="annotated-cell-2-9" class="code-annotation-target"><a href="#annotated-cell-2-9" aria-hidden="true" tabindex="-1"></a>urllib.request.urlretrieve(url, target_file)</span>
<span id="annotated-cell-2-10"><a href="#annotated-cell-2-10" aria-hidden="true" tabindex="-1"></a></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-2" data-target-annotation="4" onclick="event.preventDefault();">4</a><span id="annotated-cell-2-11" class="code-annotation-target"><a href="#annotated-cell-2-11" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> zipfile.ZipFile(target_file, <span class="st">'r'</span>) <span class="im">as</span> zip_ref:</span>
<span id="annotated-cell-2-12"><a href="#annotated-cell-2-12" aria-hidden="true" tabindex="-1"></a>    zip_ref.extractall(target_dir)</span>
<span id="annotated-cell-2-13"><a href="#annotated-cell-2-13" aria-hidden="true" tabindex="-1"></a></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-2" data-target-annotation="5" onclick="event.preventDefault();">5</a><span id="annotated-cell-2-14" class="code-annotation-target"><a href="#annotated-cell-2-14" aria-hidden="true" tabindex="-1"></a>os.rename(target_dir <span class="op">+</span> <span class="st">'/data'</span>, target_dir <span class="op">+</span> <span class="st">'/lnb'</span>)</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-2" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-2" data-code-lines="1,2,3" data-code-annotation="1">Imports the Python libraries: <code>urllib</code> for the download, and <code>zipfile</code> for uncompressing</span>
</dd>
<dt data-target-cell="annotated-cell-2" data-target-annotation="2">2</dt>
<dd>
<span data-code-cell="annotated-cell-2" data-code-lines="5,6,7" data-code-annotation="2">creats variables</span>
</dd>
<dt data-target-cell="annotated-cell-2" data-target-annotation="3">3</dt>
<dd>
<span data-code-cell="annotated-cell-2" data-code-lines="9" data-code-annotation="3">calls the download function with two arguments: the URL of the data source and the target file in our system</span>
</dd>
<dt data-target-cell="annotated-cell-2" data-target-annotation="4">4</dt>
<dd>
<span data-code-cell="annotated-cell-2" data-code-lines="11" data-code-annotation="4">uncompresses the zip file to our target directory</span>
</dd>
<dt data-target-cell="annotated-cell-2" data-target-annotation="5">5</dt>
<dd>
<span data-code-cell="annotated-cell-2" data-code-lines="14" data-code-annotation="5">renames the <code>data</code> subdirectory (comes inside the zip file) to <code>lnb</code></span>
</dd>
</dl>
<p>At the end of the process we will have a file <code>raw-data/lnb/natl_bibliography-2014-2023-marc.xml</code>, a set of MARC21 record in MARCXML serialization format, that is MARC21 in XML.</p>
<p>The code of this section is available at <code>scripts/ch3a-download-a-file.py</code> of the repository.</p>
</section>
<section id="apis-to-retrieve-records" class="level2" data-number="5.3">
<h2 data-number="5.3" class="anchored" data-anchor-id="apis-to-retrieve-records"><span class="header-section-number">5.3</span> APIs to retrieve records</h2>
<section id="oai-pmh" class="level3" data-number="5.3.1">
<h3 data-number="5.3.1" class="anchored" data-anchor-id="oai-pmh"><span class="header-section-number">5.3.1</span> OAI-PMH</h3>
<blockquote class="blockquote">
<p>The Open Archives Initiative Protocol for Metadata Harvesting (OAI-PMH) is a low-barrier mechanism for repository interoperability. Data Providers are repositories that expose structured metadata via OAI-PMH. Service Providers then make OAI-PMH service requests to harvest that metadata. OAI-PMH is a set of six verbs or services that are invoked within HTTP. From <a href="https://www.openarchives.org/pmh/">https://www.openarchives.org/pmh/</a></p>
</blockquote>
<p>The protocol provides 6 ‘verbs’ or endpoints to retrieve information:</p>
<ul>
<li><a href="https://www.openarchives.org/OAI/openarchivesprotocol.html#GetRecord">GetRecord</a>: to retrieve an individual metadata record</li>
<li><a href="https://www.openarchives.org/OAI/openarchivesprotocol.html#Identify">Identify</a>: information about a repository</li>
<li><a href="https://www.openarchives.org/OAI/openarchivesprotocol.html#ListIdentifiers">ListIdentifiers</a>: to harvest record identifiers</li>
<li><a href="https://www.openarchives.org/OAI/openarchivesprotocol.html#ListMetadataFormats">ListMetadataFormats</a>: to retrieve the metadata formats available from a repository. These formats are alternative XML representations of the same content, but it also happens that a library provides different content via different formats. In the <code>ListIdentifiers</code> and <code>ListRecords</code> verbs it is used as the <code>metadataPrefix</code> parameter. At least one format, the Dublin Core is mandatory.</li>
<li><a href="https://www.openarchives.org/OAI/openarchivesprotocol.html#ListRecords">ListRecords</a>: to harvest records</li>
<li><a href="https://www.openarchives.org/OAI/openarchivesprotocol.html#ListSets">ListSets</a>: to retrieve the set structure of a repository. Sets are optional collections within a repository, e.g.&nbsp;there might be individual sets according to the physical collections of a library.</li>
</ul>
<p>The response of these verbs is always XML. For the List* verbs the maintainer of the service sets a pager size, so you do not retrieve all records at once, only limited number (e.g.&nbsp;100). The pagination is implemented by a distinct XML element called <code>resumptionToken</code>, which the client should use in the next call. Its value can change from call to call, so the client always have to extract is. In the above links you can find more detailed information and examples.</p>
<p>There are different implementations of OAI-PMH clients in Python, we use <a href="https://github.com/mloesch">Mathias Loesch</a>’s <a href="https://github.com/mloesch/sickle">Sickle</a> module (version 0.7.0) to retrieve the Estonian National Bibliography from the <a href="https://digilab.rara.ee/en/">DataLab</a>, the data sharing platform of the Estonian National Library. At the time of writing it returns almost 410 000 MARCXML records. We save them into local files each containing 100 000 records. As OAI-PMH is based on XML technology we use the <a href="https://lxml.de/">lxml</a> module (version 6.0.0), a lightweight XML and HTML processing toolbox.</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="annotated-cell-3"><pre class="sourceCode python code-annotation-code code-with-copy code-annotated"><code class="sourceCode python"><span id="annotated-cell-3-1"><a href="#annotated-cell-3-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> io</span>
<span id="annotated-cell-3-2"><a href="#annotated-cell-3-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> sys</span>
<span id="annotated-cell-3-3"><a href="#annotated-cell-3-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="annotated-cell-3-4"><a href="#annotated-cell-3-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> lxml <span class="im">import</span> etree</span>
<span id="annotated-cell-3-5"><a href="#annotated-cell-3-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sickle <span class="im">import</span> Sickle</span>
<span id="annotated-cell-3-6"><a href="#annotated-cell-3-6" aria-hidden="true" tabindex="-1"></a></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-3" data-target-annotation="1" onclick="event.preventDefault();">1</a><span id="annotated-cell-3-7" class="code-annotation-target"><a href="#annotated-cell-3-7" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="bu">len</span>(sys.argv) <span class="op">==</span> <span class="dv">1</span>:</span>
<span id="annotated-cell-3-8"><a href="#annotated-cell-3-8" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">'Please give a directory name'</span>)</span>
<span id="annotated-cell-3-9"><a href="#annotated-cell-3-9" aria-hidden="true" tabindex="-1"></a>    exit()</span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-3" data-target-annotation="2" onclick="event.preventDefault();">2</a><span id="annotated-cell-3-10" class="code-annotation-target"><a href="#annotated-cell-3-10" aria-hidden="true" tabindex="-1"></a><span class="bu">dir</span> <span class="op">=</span> sys.argv[<span class="dv">1</span>]</span>
<span id="annotated-cell-3-11"><a href="#annotated-cell-3-11" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="kw">not</span> os.path.exists(<span class="bu">dir</span>):</span>
<span id="annotated-cell-3-12"><a href="#annotated-cell-3-12" aria-hidden="true" tabindex="-1"></a>    os.mkdir(<span class="bu">dir</span>)</span>
<span id="annotated-cell-3-13"><a href="#annotated-cell-3-13" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'saving to </span><span class="sc">%s</span><span class="st">'</span> <span class="op">%</span> (<span class="bu">dir</span>))</span>
<span id="annotated-cell-3-14"><a href="#annotated-cell-3-14" aria-hidden="true" tabindex="-1"></a></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-3" data-target-annotation="3" onclick="event.preventDefault();">3</a><span id="annotated-cell-3-15" class="code-annotation-target"><a href="#annotated-cell-3-15" aria-hidden="true" tabindex="-1"></a>namespaces <span class="op">=</span> {</span>
<span id="annotated-cell-3-16"><a href="#annotated-cell-3-16" aria-hidden="true" tabindex="-1"></a>    <span class="st">'oai'</span>: <span class="st">'http://www.openarchives.org/OAI/2.0/'</span>,</span>
<span id="annotated-cell-3-17"><a href="#annotated-cell-3-17" aria-hidden="true" tabindex="-1"></a>    <span class="st">'marc21'</span>: <span class="st">'http://www.loc.gov/MARC21/slim'</span></span>
<span id="annotated-cell-3-18"><a href="#annotated-cell-3-18" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="annotated-cell-3-19"><a href="#annotated-cell-3-19" aria-hidden="true" tabindex="-1"></a></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-3" data-target-annotation="4" onclick="event.preventDefault();">4</a><span id="annotated-cell-3-20" class="code-annotation-target"><a href="#annotated-cell-3-20" aria-hidden="true" tabindex="-1"></a>header <span class="op">=</span> <span class="st">'&lt;?xml version="1.0" encoding="utf8"?&gt;'</span> <span class="op">+</span> <span class="st">"</span><span class="ch">\n</span><span class="st">"</span> <span class="op">\</span></span>
<span id="annotated-cell-3-21"><a href="#annotated-cell-3-21" aria-hidden="true" tabindex="-1"></a>       <span class="op">+</span> <span class="st">'&lt;collection&gt;'</span> <span class="op">+</span> <span class="st">"</span><span class="ch">\n</span><span class="st">"</span></span>
<span id="annotated-cell-3-22"><a href="#annotated-cell-3-22" aria-hidden="true" tabindex="-1"></a>footer <span class="op">=</span> <span class="st">'&lt;/collection&gt;'</span></span>
<span id="annotated-cell-3-23"><a href="#annotated-cell-3-23" aria-hidden="true" tabindex="-1"></a></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-3" data-target-annotation="5" onclick="event.preventDefault();">5</a><span id="annotated-cell-3-24" class="code-annotation-target"><a href="#annotated-cell-3-24" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> write_output(xmlrecords, file_counter, dir_name):</span>
<span id="annotated-cell-3-25"><a href="#annotated-cell-3-25" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="annotated-cell-3-26"><a href="#annotated-cell-3-26" aria-hidden="true" tabindex="-1"></a><span class="co">    Writes MARC records to file</span></span>
<span id="annotated-cell-3-27"><a href="#annotated-cell-3-27" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters                              </span></span>
<span id="annotated-cell-3-28"><a href="#annotated-cell-3-28" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="annotated-cell-3-29"><a href="#annotated-cell-3-29" aria-hidden="true" tabindex="-1"></a><span class="co">    xmlrecords : list</span></span>
<span id="annotated-cell-3-30"><a href="#annotated-cell-3-30" aria-hidden="true" tabindex="-1"></a><span class="co">        A list of string contains the individual MARCXML records</span></span>
<span id="annotated-cell-3-31"><a href="#annotated-cell-3-31" aria-hidden="true" tabindex="-1"></a><span class="co">    file_counter : int</span></span>
<span id="annotated-cell-3-32"><a href="#annotated-cell-3-32" aria-hidden="true" tabindex="-1"></a><span class="co">        A file name counter</span></span>
<span id="annotated-cell-3-33"><a href="#annotated-cell-3-33" aria-hidden="true" tabindex="-1"></a><span class="co">    dir_name : int</span></span>
<span id="annotated-cell-3-34"><a href="#annotated-cell-3-34" aria-hidden="true" tabindex="-1"></a><span class="co">        The name of the output directory</span></span>
<span id="annotated-cell-3-35"><a href="#annotated-cell-3-35" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="annotated-cell-3-36"><a href="#annotated-cell-3-36" aria-hidden="true" tabindex="-1"></a>    file_name <span class="op">=</span> <span class="st">"</span><span class="sc">%s</span><span class="st">/</span><span class="sc">%06d</span><span class="st">.xml"</span> <span class="op">%</span> (dir_name, counter)</span>
<span id="annotated-cell-3-37"><a href="#annotated-cell-3-37" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(file_name)</span>
<span id="annotated-cell-3-38"><a href="#annotated-cell-3-38" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> io.<span class="bu">open</span>(file_name, <span class="st">'w'</span>, encoding<span class="op">=</span><span class="st">'utf8'</span>) <span class="im">as</span> f:</span>
<span id="annotated-cell-3-39"><a href="#annotated-cell-3-39" aria-hidden="true" tabindex="-1"></a>        f.write(header)</span>
<span id="annotated-cell-3-40"><a href="#annotated-cell-3-40" aria-hidden="true" tabindex="-1"></a>        f.write(<span class="st">"</span><span class="ch">\n</span><span class="st">"</span>.join(xmlrecords) <span class="op">+</span> <span class="st">"</span><span class="ch">\n</span><span class="st">"</span>)</span>
<span id="annotated-cell-3-41"><a href="#annotated-cell-3-41" aria-hidden="true" tabindex="-1"></a>        f.write(footer)</span>
<span id="annotated-cell-3-42"><a href="#annotated-cell-3-42" aria-hidden="true" tabindex="-1"></a></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-3" data-target-annotation="6" onclick="event.preventDefault();">6</a><span id="annotated-cell-3-43" class="code-annotation-target"><a href="#annotated-cell-3-43" aria-hidden="true" tabindex="-1"></a>sickle <span class="op">=</span> Sickle(<span class="st">'https://data.digar.ee/repox/OAIHandler'</span>, max_retries<span class="op">=</span><span class="dv">4</span>)</span>
<span id="annotated-cell-3-44"><a href="#annotated-cell-3-44" aria-hidden="true" tabindex="-1"></a></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-3" data-target-annotation="7" onclick="event.preventDefault();">7</a><span id="annotated-cell-3-45" class="code-annotation-target"><a href="#annotated-cell-3-45" aria-hidden="true" tabindex="-1"></a>xmlrecords <span class="op">=</span> []</span>
<span id="annotated-cell-3-46"><a href="#annotated-cell-3-46" aria-hidden="true" tabindex="-1"></a>file_counter <span class="op">=</span> <span class="dv">0</span></span>
<span id="annotated-cell-3-47"><a href="#annotated-cell-3-47" aria-hidden="true" tabindex="-1"></a>record_counter <span class="op">=</span> <span class="dv">0</span></span>
<span id="annotated-cell-3-48"><a href="#annotated-cell-3-48" aria-hidden="true" tabindex="-1"></a></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-3" data-target-annotation="8" onclick="event.preventDefault();">8</a><span id="annotated-cell-3-49" class="code-annotation-target"><a href="#annotated-cell-3-49" aria-hidden="true" tabindex="-1"></a>it <span class="op">=</span> sickle.ListRecords(metadataPrefix<span class="op">=</span><span class="st">'marc21xml'</span>, <span class="bu">set</span><span class="op">=</span><span class="st">'erb'</span>)</span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-3" data-target-annotation="9" onclick="event.preventDefault();">9</a><span id="annotated-cell-3-50" class="code-annotation-target"><a href="#annotated-cell-3-50" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> content <span class="kw">in</span> it:</span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-3" data-target-annotation="10" onclick="event.preventDefault();">10</a><span id="annotated-cell-3-51" class="code-annotation-target"><a href="#annotated-cell-3-51" aria-hidden="true" tabindex="-1"></a>    tree <span class="op">=</span> etree.ElementTree(content)</span>
<span id="annotated-cell-3-52"><a href="#annotated-cell-3-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-3-53"><a href="#annotated-cell-3-53" aria-hidden="true" tabindex="-1"></a>    records <span class="op">=</span> tree.xpath(</span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-3" data-target-annotation="11" onclick="event.preventDefault();">11</a><span id="annotated-cell-3-54" class="code-annotation-target"><a href="#annotated-cell-3-54" aria-hidden="true" tabindex="-1"></a>                  <span class="st">'/oai:record[*]/oai:metadata/marc21:record'</span>,</span>
<span id="annotated-cell-3-55"><a href="#annotated-cell-3-55" aria-hidden="true" tabindex="-1"></a>                  namespaces<span class="op">=</span>namespaces)</span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-3" data-target-annotation="12" onclick="event.preventDefault();">12</a><span id="annotated-cell-3-56" class="code-annotation-target"><a href="#annotated-cell-3-56" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> record <span class="kw">in</span> records:</span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-3" data-target-annotation="13" onclick="event.preventDefault();">13</a><span id="annotated-cell-3-57" class="code-annotation-target"><a href="#annotated-cell-3-57" aria-hidden="true" tabindex="-1"></a>        xmlrecord <span class="op">=</span> etree<span class="op">\</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-3" data-target-annotation="14" onclick="event.preventDefault();">14</a><span id="annotated-cell-3-58" class="code-annotation-target"><a href="#annotated-cell-3-58" aria-hidden="true" tabindex="-1"></a>              .tostring(record, encoding<span class="op">=</span><span class="st">'utf8'</span>, method<span class="op">=</span><span class="st">'xml'</span>)<span class="op">\</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-3" data-target-annotation="15" onclick="event.preventDefault();">15</a><span id="annotated-cell-3-59" class="code-annotation-target"><a href="#annotated-cell-3-59" aria-hidden="true" tabindex="-1"></a>              .decode(<span class="st">"utf-8"</span>)<span class="op">\</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-3" data-target-annotation="16" onclick="event.preventDefault();">16</a><span id="annotated-cell-3-60" class="code-annotation-target"><a href="#annotated-cell-3-60" aria-hidden="true" tabindex="-1"></a>              .replace(<span class="st">"&lt;?xml version='1.0' encoding='utf8'?&gt;</span><span class="ch">\n</span><span class="st">"</span>, <span class="st">''</span>)</span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-3" data-target-annotation="17" onclick="event.preventDefault();">17</a><span id="annotated-cell-3-61" class="code-annotation-target"><a href="#annotated-cell-3-61" aria-hidden="true" tabindex="-1"></a>        xmlrecords.append(xmlrecord)</span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-3" data-target-annotation="18" onclick="event.preventDefault();">18</a><span id="annotated-cell-3-62" class="code-annotation-target"><a href="#annotated-cell-3-62" aria-hidden="true" tabindex="-1"></a>        record_counter <span class="op">+=</span> <span class="dv">1</span></span>
<span id="annotated-cell-3-63"><a href="#annotated-cell-3-63" aria-hidden="true" tabindex="-1"></a></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-3" data-target-annotation="19" onclick="event.preventDefault();">19</a><span id="annotated-cell-3-64" class="code-annotation-target"><a href="#annotated-cell-3-64" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">len</span>(xmlrecords) <span class="op">&gt;=</span> <span class="dv">100000</span>:</span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-3" data-target-annotation="20" onclick="event.preventDefault();">20</a><span id="annotated-cell-3-65" class="code-annotation-target"><a href="#annotated-cell-3-65" aria-hidden="true" tabindex="-1"></a>        write_output(xmlrecords, file_counter, <span class="bu">dir</span>)</span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-3" data-target-annotation="21" onclick="event.preventDefault();">21</a><span id="annotated-cell-3-66" class="code-annotation-target"><a href="#annotated-cell-3-66" aria-hidden="true" tabindex="-1"></a>        xmlrecords <span class="op">=</span> []</span>
<span id="annotated-cell-3-67"><a href="#annotated-cell-3-67" aria-hidden="true" tabindex="-1"></a>        file_counter <span class="op">+=</span> <span class="dv">1</span></span>
<span id="annotated-cell-3-68"><a href="#annotated-cell-3-68" aria-hidden="true" tabindex="-1"></a></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-3" data-target-annotation="22" onclick="event.preventDefault();">22</a><span id="annotated-cell-3-69" class="code-annotation-target"><a href="#annotated-cell-3-69" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="bu">len</span>(xmlrecords) <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="annotated-cell-3-70"><a href="#annotated-cell-3-70" aria-hidden="true" tabindex="-1"></a>    write_output(xmlrecords, file_counter, <span class="bu">dir</span>)</span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-3" data-target-annotation="23" onclick="event.preventDefault();">23</a><span id="annotated-cell-3-71" class="code-annotation-target"><a href="#annotated-cell-3-71" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'saved </span><span class="sc">%d</span><span class="st"> records to </span><span class="sc">%d</span><span class="st"> files'</span> <span class="op">%</span> (record_counter, file_counter))</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-3" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-3" data-code-lines="7" data-code-annotation="1">When we run Python, the <code>sys.argv</code> list contains the arguments we passed to the interpreter. The <code>len()</code> function returns the number of elements in a collection, so it gives here the number of arguments. The first argument is the name of the current script, so if the number here is zero it means that the script itself does not have any argument. We should pass at least one argument: the name of the directory where the script will store the records – if we don’t provide it, the script will send us a message and stop running (with the <code>exit()</code> function).</span>
</dd>
<dt data-target-cell="annotated-cell-3" data-target-annotation="2">2</dt>
<dd>
<span data-code-cell="annotated-cell-3" data-code-lines="10" data-code-annotation="2">If we provide an argument it will be stored as the name of the output directory. Then it creates the directory if it does not already exist, and notify us.</span>
</dd>
<dt data-target-cell="annotated-cell-3" data-target-annotation="3">3</dt>
<dd>
<span data-code-cell="annotated-cell-3" data-code-lines="15" data-code-annotation="3"><code>namespaces</code> variable registers the XML namespaces the process needs - otherwise the XPath expressions would not work.</span>
</dd>
<dt data-target-cell="annotated-cell-3" data-target-annotation="4">4</dt>
<dd>
<span data-code-cell="annotated-cell-3" data-code-lines="20" data-code-annotation="4"><code>header</code> and <code>footer</code> needs at the beginning and end of the output XML files. The XML files are hierarchical: their main content is a list of MARC records, and their parent element will be the <code>&lt;collection&gt;</code>.</span>
</dd>
<dt data-target-cell="annotated-cell-3" data-target-annotation="5">5</dt>
<dd>
<span data-code-cell="annotated-cell-3" data-code-lines="24" data-code-annotation="5"><code>write_output()</code> function creates the output files in the specified directory. It prints the XML header, join together and prints the XML records, and finally prints the XML footer.</span>
</dd>
<dt data-target-cell="annotated-cell-3" data-target-annotation="6">6</dt>
<dd>
<span data-code-cell="annotated-cell-3" data-code-lines="43" data-code-annotation="6">The Sickle harvester is initialized with the endpoint of the OAI-PMH service and an extra argument to specify how many times it can retry to fetch a single URL. It is needed because sometimes there are communication problems between the server and the client (due to problems on either side or in the network).</span>
</dd>
<dt data-target-cell="annotated-cell-3" data-target-annotation="7">7</dt>
<dd>
<span data-code-cell="annotated-cell-3" data-code-lines="45" data-code-annotation="7">Initialisation of the necessary variables: the collector of the individual records, the output file counter and the record counter.</span>
</dd>
<dt data-target-cell="annotated-cell-3" data-target-annotation="8">8</dt>
<dd>
<span data-code-cell="annotated-cell-3" data-code-lines="49" data-code-annotation="8">Start the harvest using the <code>ListRecords</code> verb. It returns an iterator, so we should not take care of pagination with individual HTTP calls and resumptionToken mentioned above, it is handled automatically by the Sickle module. We use two arguments: we set the metadata schema as MARCXML and the set as <code>erb</code> which stands for the Estonian National Bibliography. These values can be extracted from a preliminary investigation of the supported values returned by the <code>ListMetadataFormats</code> and <code>ListSets</code> verbs.</span>
</dd>
<dt data-target-cell="annotated-cell-3" data-target-annotation="9">9</dt>
<dd>
<span data-code-cell="annotated-cell-3" data-code-lines="50" data-code-annotation="9">In the following the script iterates over the individual XML responses of the calls.</span>
</dd>
<dt data-target-cell="annotated-cell-3" data-target-annotation="10">10</dt>
<dd>
<span data-code-cell="annotated-cell-3" data-code-lines="51" data-code-annotation="10">The raw XML content is transformed to an <a href="https://docs.python.org/3/library/xml.etree.elementtree.html">XML element tree</a> that is an internal data structure with an API.</span>
</dd>
<dt data-target-cell="annotated-cell-3" data-target-annotation="11">11</dt>
<dd>
<span data-code-cell="annotated-cell-3" data-code-lines="54" data-code-annotation="11">Selection of the individual records with an XPath expression. For the expression we should provide the XML namespace. In OAI-PMH the individual records (<code>&lt;oai:record&gt;</code>) have two parts: a header, that contains record identifier and other metadata (such as the set it belongs to, the date of last modification) and the actual record (<code>&lt;oai:metadata&gt;</code>). This later is the container of the MARCXML record (<code>&lt;marc21:record&gt;</code>). If you would like to apply this script to another OAI-PMH server, please check the namespaces it uses. The abbreviations are not important, you can name them as you like (however to keep them as in the source, i.e.&nbsp;the XML response of the service helps in debugging the problems, if there are), but you should always use the URLs used by the service.</span>
</dd>
<dt data-target-cell="annotated-cell-3" data-target-annotation="12">12</dt>
<dd>
<span data-code-cell="annotated-cell-3" data-code-lines="56" data-code-annotation="12">Iterate over the individual records that <code>xpath()</code> returned.</span>
</dd>
<dt data-target-cell="annotated-cell-3" data-target-annotation="13">13</dt>
<dd>
<span data-code-cell="annotated-cell-3" data-code-lines="57" data-code-annotation="13">Transformation of the above mentioned tree structure of the record to XML via a sequence of steps:</span>
</dd>
<dt data-target-cell="annotated-cell-3" data-target-annotation="14">14</dt>
<dd>
<span data-code-cell="annotated-cell-3" data-code-lines="58" data-code-annotation="14">create the XML string…</span>
</dd>
<dt data-target-cell="annotated-cell-3" data-target-annotation="15">15</dt>
<dd>
<span data-code-cell="annotated-cell-3" data-code-lines="59" data-code-annotation="15">convert to UTF-8 encoding…</span>
</dd>
<dt data-target-cell="annotated-cell-3" data-target-annotation="16">16</dt>
<dd>
<span data-code-cell="annotated-cell-3" data-code-lines="60" data-code-annotation="16">remove the <a href="https://www.w3.org/TR/REC-xml/#dt-xmldecl">XML declaration</a> – we do not need it for each record.</span>
</dd>
<dt data-target-cell="annotated-cell-3" data-target-annotation="17">17</dt>
<dd>
<span data-code-cell="annotated-cell-3" data-code-lines="61" data-code-annotation="17">add the record into the record collection</span>
</dd>
<dt data-target-cell="annotated-cell-3" data-target-annotation="18">18</dt>
<dd>
<span data-code-cell="annotated-cell-3" data-code-lines="62" data-code-annotation="18">increase the record counter by one</span>
</dd>
<dt data-target-cell="annotated-cell-3" data-target-annotation="19">19</dt>
<dd>
<span data-code-cell="annotated-cell-3" data-code-lines="64" data-code-annotation="19">if the record collection contains more than 100 000 records…</span>
</dd>
<dt data-target-cell="annotated-cell-3" data-target-annotation="20">20</dt>
<dd>
<span data-code-cell="annotated-cell-3" data-code-lines="65" data-code-annotation="20">the records should be written to a file…</span>
</dd>
<dt data-target-cell="annotated-cell-3" data-target-annotation="21">21</dt>
<dd>
<span data-code-cell="annotated-cell-3" data-code-lines="66" data-code-annotation="21">then empty the collection, and increase file counter by one</span>
</dd>
<dt data-target-cell="annotated-cell-3" data-target-annotation="22">22</dt>
<dd>
<span data-code-cell="annotated-cell-3" data-code-lines="69" data-code-annotation="22">after the iteration if the record collection is not empty write it to a file</span>
</dd>
<dt data-target-cell="annotated-cell-3" data-target-annotation="23">23</dt>
<dd>
<span data-code-cell="annotated-cell-3" data-code-lines="71" data-code-annotation="23">finally notify the user about the number of records ingested and files written</span>
</dd>
</dl>
</section>
</section>
<section id="download-an-sql-file" class="level2" data-number="5.4">
<h2 data-number="5.4" class="anchored" data-anchor-id="download-an-sql-file"><span class="header-section-number">5.4</span> Download an SQL file</h2>
<p>Some bibliographic data sources are available as a relational database. These databases are distributed as a so-called <code>SQL dump</code>, a non binary text based file, that contains both the definition of the database structure (the properties of tables and columns), and the values. The dump files can be imported to the database. In this section we will import the following database:</p>
<blockquote class="blockquote">
<p>Simon Burrows and Mark Curran, The French Book Trade in Enlightenment Europe Database, 1769-1794 (<a href="https://fbtee.westernsydney.edu.au/stn/interface/">https://fbtee.westernsydney.edu.au/stn/interface/</a>, 6 May 2014)</p>
</blockquote>
<p>It maps the trade of the Société Typographique de Neuchâtel, 1769-1794, and based on the almost intactly surviving archive of the alliance of the printers at Neuchâtel (Switzerland). The database (henceforth <em>FBTEE</em>) could be imported into MySQL or its Open Source form MariaDB. the database is downloadable from <a href="https://fbtee.westernsydney.edu.au/main/download-database/">https://fbtee.westernsydney.edu.au/main/download-database/</a>.</p>
<p>As now we would like to download another file we might choose to copy the previous script, and replace the variables <code>url</code> and <code>target_file</code> with another one, but it would duplicate the business logic of the script. In software development there is a principle <em>Don’t Repeat Yourself</em> abbreviated as <em>DRY</em>. It suggests that we should avoid code repetition, or in other words: the code should be reusable. Instead of writing two (or more) specialized scripts that repeat the actual download and uncompressing part, we will create a function that will be used by these scripts.</p>
<p>First we will create a utility script that will contain functions we can use in the course. It will be called bdsutils (short for Bibliographic Data Science utilities). This is the</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="annotated-cell-4"><pre class="sourceCode python code-annotation-code code-with-copy code-annotated"><code class="sourceCode python"><span id="annotated-cell-4-1"><a href="#annotated-cell-4-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> urllib.request</span>
<span id="annotated-cell-4-2"><a href="#annotated-cell-4-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> zipfile</span>
<span id="annotated-cell-4-3"><a href="#annotated-cell-4-3" aria-hidden="true" tabindex="-1"></a></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-4" data-target-annotation="1" onclick="event.preventDefault();">1</a><span id="annotated-cell-4-4" class="code-annotation-target"><a href="#annotated-cell-4-4" aria-hidden="true" tabindex="-1"></a>target_dir <span class="op">=</span> <span class="st">'raw-data'</span></span>
<span id="annotated-cell-4-5"><a href="#annotated-cell-4-5" aria-hidden="true" tabindex="-1"></a></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-4" data-target-annotation="2" onclick="event.preventDefault();">2</a><span id="annotated-cell-4-6" class="code-annotation-target"><a href="#annotated-cell-4-6" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> download_and_unzip(url, target_file):</span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-4" data-target-annotation="3" onclick="event.preventDefault();">3</a><span id="annotated-cell-4-7" class="code-annotation-target"><a href="#annotated-cell-4-7" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="annotated-cell-4-8"><a href="#annotated-cell-4-8" aria-hidden="true" tabindex="-1"></a><span class="co">    Download a zip file, and uncompress it</span></span>
<span id="annotated-cell-4-9"><a href="#annotated-cell-4-9" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="annotated-cell-4-10"><a href="#annotated-cell-4-10" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters</span></span>
<span id="annotated-cell-4-11"><a href="#annotated-cell-4-11" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="annotated-cell-4-12"><a href="#annotated-cell-4-12" aria-hidden="true" tabindex="-1"></a><span class="co">    url : str</span></span>
<span id="annotated-cell-4-13"><a href="#annotated-cell-4-13" aria-hidden="true" tabindex="-1"></a><span class="co">        The URL of the zip file to download</span></span>
<span id="annotated-cell-4-14"><a href="#annotated-cell-4-14" aria-hidden="true" tabindex="-1"></a><span class="co">    sound : str</span></span>
<span id="annotated-cell-4-15"><a href="#annotated-cell-4-15" aria-hidden="true" tabindex="-1"></a><span class="co">        The local file name</span></span>
<span id="annotated-cell-4-16"><a href="#annotated-cell-4-16" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="annotated-cell-4-17"><a href="#annotated-cell-4-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-4-18"><a href="#annotated-cell-4-18" aria-hidden="true" tabindex="-1"></a>    urllib.request.urlretrieve(url, target_file)</span>
<span id="annotated-cell-4-19"><a href="#annotated-cell-4-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-4-20"><a href="#annotated-cell-4-20" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> zipfile.ZipFile(target_file, <span class="st">'r'</span>) <span class="im">as</span> zip_ref:</span>
<span id="annotated-cell-4-21"><a href="#annotated-cell-4-21" aria-hidden="true" tabindex="-1"></a>        zip_ref.extractall(target_dir)</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-4" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-4" data-code-lines="4" data-code-annotation="1">the script keeps only one variable <code>target_dir</code>, that will remain the same across calls</span>
</dd>
<dt data-target-cell="annotated-cell-4" data-target-annotation="2">2</dt>
<dd>
<span data-code-cell="annotated-cell-4" data-code-lines="6" data-code-annotation="2">the definition of the method</span>
</dd>
<dt data-target-cell="annotated-cell-4" data-target-annotation="3">3</dt>
<dd>
<span data-code-cell="annotated-cell-4" data-code-lines="7,8,10,11,12,13,14,15,16" data-code-annotation="3">the documentation of the method</span>
</dd>
</dl>
<div class="callout callout-style-simple callout-important">
<div class="callout-body d-flex">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-body-container">
<p>TODO: The code should be explained more!</p>
</div>
</div>
</div>
<p>The file is available in the repository as <code>scripts/bdsutils.py</code>.</p>
<p>Once we have this utility script, we can create the specific one for <em>FBTEE</em>. This zip file does not contain directories, only a single file <em>chop_leeds_ac_uk.sql</em>.</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="annotated-cell-5"><pre class="sourceCode python code-annotation-code code-with-copy code-annotated"><code class="sourceCode python"><a class="code-annotation-anchor" data-target-cell="annotated-cell-5" data-target-annotation="1" onclick="event.preventDefault();">1</a><span id="annotated-cell-5-1" class="code-annotation-target"><a href="#annotated-cell-5-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> bdsutils <span class="im">import</span> target_dir, download_and_unzip</span>
<span id="annotated-cell-5-2"><a href="#annotated-cell-5-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="annotated-cell-5-3"><a href="#annotated-cell-5-3" aria-hidden="true" tabindex="-1"></a></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-5" data-target-annotation="2" onclick="event.preventDefault();">2</a><span id="annotated-cell-5-4" class="code-annotation-target"><a href="#annotated-cell-5-4" aria-hidden="true" tabindex="-1"></a>url <span class="op">=</span> <span class="st">'https://fbtee.uws.edu.au/stn/database/download/STN_database.zip'</span></span>
<span id="annotated-cell-5-5"><a href="#annotated-cell-5-5" aria-hidden="true" tabindex="-1"></a>target_file <span class="op">=</span> target_dir <span class="op">+</span> <span class="st">'/stn_database.zip'</span></span>
<span id="annotated-cell-5-6"><a href="#annotated-cell-5-6" aria-hidden="true" tabindex="-1"></a></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-5" data-target-annotation="3" onclick="event.preventDefault();">3</a><span id="annotated-cell-5-7" class="code-annotation-target"><a href="#annotated-cell-5-7" aria-hidden="true" tabindex="-1"></a>download_and_unzip(url, target_file)</span>
<span id="annotated-cell-5-8"><a href="#annotated-cell-5-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-5-9"><a href="#annotated-cell-5-9" aria-hidden="true" tabindex="-1"></a>directory <span class="op">=</span> target_dir <span class="op">+</span> <span class="st">'/fbtee'</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-5" data-target-annotation="4" onclick="event.preventDefault();">4</a><span id="annotated-cell-5-10" class="code-annotation-target"><a href="#annotated-cell-5-10" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="kw">not</span> os.path.exists(directory):</span>
<span id="annotated-cell-5-11"><a href="#annotated-cell-5-11" aria-hidden="true" tabindex="-1"></a>    os.mkdir(directory)</span>
<span id="annotated-cell-5-12"><a href="#annotated-cell-5-12" aria-hidden="true" tabindex="-1"></a></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-5" data-target-annotation="5" onclick="event.preventDefault();">5</a><span id="annotated-cell-5-13" class="code-annotation-target"><a href="#annotated-cell-5-13" aria-hidden="true" tabindex="-1"></a>os.rename(target_dir <span class="op">+</span> <span class="st">'/chop_leeds_ac_uk.sql'</span>,</span>
<span id="annotated-cell-5-14"><a href="#annotated-cell-5-14" aria-hidden="true" tabindex="-1"></a>          directory <span class="op">+</span> <span class="st">'/chop_leeds_ac_uk.sql'</span>)</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-5" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-5" data-code-lines="1" data-code-annotation="1">imports both the variable and the function from bdsutils (we should not add the <code>.py</code> extension). This way we should not use the prefix bdsutils for these components (such as <code>bdsutils.target_dir</code>)</span>
</dd>
<dt data-target-cell="annotated-cell-5" data-target-annotation="2">2</dt>
<dd>
<span data-code-cell="annotated-cell-5" data-code-lines="4" data-code-annotation="2">the definition of the <em>FBTEE</em> specific variables</span>
</dd>
<dt data-target-cell="annotated-cell-5" data-target-annotation="3">3</dt>
<dd>
<span data-code-cell="annotated-cell-5" data-code-lines="7" data-code-annotation="3">usage of the method defined in bdsutils</span>
</dd>
<dt data-target-cell="annotated-cell-5" data-target-annotation="4">4</dt>
<dd>
<span data-code-cell="annotated-cell-5" data-code-lines="10" data-code-annotation="4">creates a dedicated directory for the database if it doesn’t already exist</span>
</dd>
<dt data-target-cell="annotated-cell-5" data-target-annotation="5">5</dt>
<dd>
<span data-code-cell="annotated-cell-5" data-code-lines="13" data-code-annotation="5">moves the file to this directory</span>
</dd>
</dl>
<p>If you run it, you will have two files: - raw-data/fbtee/chop_leeds_ac_uk.sql - raw-data/stn_database.zip</p>
<p>The file is available in the repository as <code>scripts/ch3a-download-stn.py</code>.</p>
<section id="import-btee-to-the-database" class="level3" data-number="5.4.1">
<h3 data-number="5.4.1" class="anchored" data-anchor-id="import-btee-to-the-database"><span class="header-section-number">5.4.1</span> import BTEE to the database</h3>
<p>Importing a datadump into MySQL or MariaDB is a two step process. First you should create the database itself with permissions (for security reasons it is advisable to create a dedicated user as well and not to use the default database user), then you can import the data.</p>
<p>Step 1. Prepare the database</p>
<p>Log in to MySQL, then create the database <code>fbtee</code> and a dedicated user (replace <code>&lt;username&gt;</code> and <code>&lt;password&gt;</code> with your chosen credentials):</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb1"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">DATABASE</span> fbtee;</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="fu">USER</span> <span class="st">'&lt;username&gt;'</span>@<span class="st">'localhost'</span> <span class="kw">IDENTIFIED</span> <span class="kw">BY</span> <span class="st">'&lt;password&gt;'</span>;</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="kw">GRANT</span> <span class="kw">ALL</span> <span class="kw">PRIVILEGES</span> <span class="kw">ON</span> fbtee.<span class="op">*</span> <span class="kw">TO</span> <span class="st">'&lt;username&gt;'</span>@<span class="st">'localhost'</span> <span class="kw">WITH</span> <span class="kw">GRANT</span> <span class="kw">OPTION</span>;</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="kw">FLUSH</span> <span class="kw">PRIVILEGES</span>;</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>quit</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>Note: you can choose any name for the database, this material will use <code>fbtee</code>.</p>
<p>Step 2. Import the data dump</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb2"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="ex">mysql</span> <span class="at">-u</span> <span class="op">&lt;</span>username<span class="op">&gt;</span> -p fbtee <span class="op">&lt;</span> raw-data/fbtee/chop_leeds_ac_uk.sql</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>This command will ask for the password. Use the same credentials you set in Step 1. If you did not get any error message, you can check the database structure. Log in again with the dedicated credentials:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb3"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="ex">mysql</span> <span class="at">-u</span> <span class="op">&lt;</span>username<span class="op">&gt;</span> -p fbtee</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>The you can check the list of tables with</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb4"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>SHOW <span class="kw">TABLES</span>;</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>that returns</p>
<pre><code>+-------------------------------------+
| Tables_in_fbtee                     |
+-------------------------------------+
| authors                             |
| books                               |
| books_authors                       |
| books_call_numbers                  |
| books_stn_catalogues                |
| clients                             |
| clients_addresses                   |
| clients_correspondence_manuscripts  |
| clients_correspondence_places       |
| clients_people                      |
| clients_professions                 |
| keyword_assignments                 |
| keyword_free_associations           |
| keyword_tree_associations           |
| keywords                            |
| orders                              |
| orders_agents                       |
| orders_sent_via                     |
| orders_sent_via_place               |
| parisian_keywords                   |
| parisian_system_keyword_assignments |
| people                              |
| people_professions                  |
| places                              |
| professions                         |
| super_books                         |
| super_books_keywords                |
| tags                                |
| transactions                        |
| transactions_volumes_exchanged      |
+-------------------------------------+
30 rows in set (0,001 sec)</code></pre>
<p>or the structure of the <code>books</code> table with</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb6"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>DESCRIBE books;</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>The result:</p>
<pre><code>+---------------------------+---------------+------+-----+---------+-------+
| Field                     | Type          | Null | Key | Default | Extra |
+---------------------------+---------------+------+-----+---------+-------+
| book_code                 | char(9)       | NO   | PRI | NULL    |       |
| super_book_code           | char(11)      | NO   |     | NULL    |       |
| edition_status            | varchar(15)   | NO   |     | NULL    |       |
| edition_type              | varchar(50)   | NO   |     | NULL    |       |
| full_book_title           | varchar(750)  | YES  | MUL | NULL    |       |
| short_book_titles         | varchar(1000) | YES  |     | NULL    |       |
| translated_title          | varchar(750)  | YES  |     | NULL    |       |
| translated_language       | varchar(50)   | YES  | MUL | NULL    |       |
| languages                 | varchar(200)  | YES  | MUL | NULL    |       |
| stated_publishers         | varchar(1000) | YES  | MUL | NULL    |       |
| actual_publishers         | varchar(1000) | YES  |     | NULL    |       |
| stated_publication_places | varchar(1000) | YES  |     | NULL    |       |
| actual_publication_places | varchar(1000) | YES  |     | NULL    |       |
| stated_publication_years  | varchar(1000) | YES  |     | NULL    |       |
| actual_publication_years  | varchar(10)   | YES  |     | NULL    |       |
| pages                     | varchar(250)  | YES  |     | NULL    |       |
| quick_pages               | varchar(10)   | YES  |     | NULL    |       |
| number_of_volumes         | int(11)       | YES  |     | NULL    |       |
| section                   | varchar(10)   | YES  |     | NULL    |       |
| edition                   | varchar(100)  | YES  |     | NULL    |       |
| book_sheets               | varchar(200)  | YES  |     | NULL    |       |
| notes                     | varchar(4000) | YES  |     | NULL    |       |
| research_notes            | varchar(1000) | YES  |     | NULL    |       |
+---------------------------+---------------+------+-----+---------+-------+
23 rows in set (0,001 sec)</code></pre>
<p>This material is not intended to provide an introduction to SQL, if you are interested, we can suggest the Library Carpentry’s <a href="https://librarycarpentry.github.io/lc-sql/">SQL lesson</a>.</p>
</section>
</section>
<section id="web-scraping" class="level2" data-number="5.5">
<h2 data-number="5.5" class="anchored" data-anchor-id="web-scraping"><span class="header-section-number">5.5</span> Web scraping</h2>
<p>Oftentimes it happens that an interesting bibliographic data source does not provide any download or programmable access option. We have two options here. The first is to contact the data provider and ask help to access the data. If we can not find contact information, or we do not receive any answer to our question, the second option is to extract data from the public web site, called <em>screen scraping</em> or <a href="https://en.wikipedia.org/wiki/Web_scraping">web scraping</a>. In this section the method will be demonstrated on UNESCO’s Index Translationum database (IT).</p>
<p>IT collected bibliographical records describing translated books in any genre. These records came from national libraries between 1978 and roughly 2009 (IT never announced the cease of data collection, but practically records after this year are quite rare). Before 1978 IT had been published in printed volumes, however I am not aware of digitised versions. Another important problem is that the IT website is not always available.</p>
<p>The database does not provide browsing functionality, so one should start with a query, such as looking for translations of an author, or translations from a particular language (specifying the <em>source language</em>). The search queries (expressed as URLs) look like these:</p>
<ul>
<li>for authors: <code>https://www.unesco.org/xtrans/bsresult.aspx?a=[author]</code>, where <code>[author]</code> should contain the URL encoded name of the author in family name, first name format (e.g.&nbsp;William Shakespeare should be encoded as Shakespeare,%20William)</li>
<li>for source language: <code>https://www.unesco.org/xtrans/bsresult.aspx?sl=[language code]&amp;tie=a</code>, where the <code>[language code]</code> should be substituted with a concrete language code, such as <code>hun</code> for Hungarian</li>
</ul>
<p>You can play at the user interface to find the good initial query term, then you can start with the code (note: the URL encoding is done by the web form, but if you do it programmatically you have to take care with your programming language).</p>
<p>A note on terminology: in translation study the language from which the work has been written is called the <em>source language</em>, and the translation is written in the <em>target language</em>. Sometimes the translator does not work from the source language, but from another translation, the language of which is called the <em>intermediate language</em>.</p>
<p>A note on code: every HTML code in this section is a bit formatted by adding spaces and line breaks in order to make it easier to understand. For the original format please check IT’s HTML source.</p>
<p>The result is a HTML page that you have to parse and extract data. The first thing we extract now is pagination. You receive only 10 results for a single query. The next set can be accessed by clicking on the right arrow icon representing the link to the next page. Fortunately IT applies the class attribute of the HTML element to inject some semantics into the page, and we will utilize this feature. Here is the next link’s HTML structure:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb8"><pre class="sourceCode html code-with-copy"><code class="sourceCode html"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">td</span><span class="ot"> class</span><span class="op">=</span><span class="st">”next”</span><span class="dt">&gt;</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&lt;</span><span class="kw">a</span><span class="ot"> href</span><span class="op">=</span><span class="st">”bsresult.aspx?lg</span><span class="er">=</span><span class="st">0</span><span class="dv">&amp;amp;</span><span class="st">a</span><span class="er">=</span><span class="st">Shakespeare,</span><span class="ot"> William</span><span class="er">&amp;</span><span class="ot">amp</span><span class="er">;</span><span class="ot">fr</span><span class="op">=</span><span class="st">10”</span><span class="dt">&gt;</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&lt;</span><span class="kw">img</span><span class="ot"> border</span><span class="op">=</span><span class="st">”0”</span><span class="ot"> src</span><span class="op">=</span><span class="st">”Images/cy_r_arr.gif”</span><span class="ot"> alt</span><span class="op">=</span><span class="st">”prev”</span><span class="dt">&gt;</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&lt;/</span><span class="kw">a</span><span class="dt">&gt;</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;/</span><span class="kw">td</span><span class="dt">&gt;</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>The <code>class=”next”</code> part is unique in the page, however on the last page it is empty, since there are no more hits. Thus we should parse it in two steps: first get the content of the <code>&lt;td&gt;</code> element, then we should find inside the <code>&lt;a&gt;</code> element’s <code>href</code> attribute. Since it contains a relative link, in order to fetch it, we should add <code>https://www.unesco.org/xtrans/</code> to the beginning. We can continue the iteration until the td element becomes empty.</p>
<p>The next thing is to parse the content, the individual bibliographical descriptions. The results are displayed in a table structure, where the table has the following structure:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb9"><pre class="sourceCode html code-with-copy"><code class="sourceCode html"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">table</span><span class="ot"> class</span><span class="op">=</span><span class="st">”restable”</span><span class="dt">&gt;</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&lt;</span><span class="kw">tr</span><span class="dt">&gt;</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&lt;</span><span class="kw">td</span><span class="ot"> class</span><span class="op">=</span><span class="st">”res1”</span><span class="dt">&gt;</span>1/4380<span class="dt">&lt;/</span><span class="kw">td</span><span class="dt">&gt;</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&lt;</span><span class="kw">td</span><span class="ot"> class</span><span class="op">=</span><span class="st">”res2”</span><span class="dt">&gt;</span>[bibliographical description]<span class="dt">&lt;/</span><span class="kw">td</span><span class="dt">&gt;</span></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&lt;/</span><span class="kw">tr</span><span class="dt">&gt;</span></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&lt;</span><span class="kw">tr</span><span class="dt">&gt;</span></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&lt;</span><span class="kw">td</span><span class="ot"> class</span><span class="op">=</span><span class="st">”res1”</span><span class="dt">&gt;</span>2/4380<span class="dt">&lt;/</span><span class="kw">td</span><span class="dt">&gt;</span></span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&lt;</span><span class="kw">td</span><span class="ot"> class</span><span class="op">=</span><span class="st">”res2”</span><span class="dt">&gt;</span>[bibliographical description]<span class="dt">&lt;/</span><span class="kw">td</span><span class="dt">&gt;</span></span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&lt;/</span><span class="kw">tr</span><span class="dt">&gt;</span></span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>  ...</span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;/</span><span class="kw">table</span><span class="dt">&gt;</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>so we should find the table with <code>class=”restable”</code>, then inside it we should process the bibliographical descriptions, which always take place in a cell (<code>&lt;td&gt;</code> element) with <code>class=”res2”</code>.</p>
<p>Thanks to the unknown software designers and developers behind IT, all elements of the bibliographical description are in a semantically identifiable <code>&lt;span&gt;</code> element. Here is an example:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb10"><pre class="sourceCode html code-with-copy"><code class="sourceCode html"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">td</span><span class="ot"> class</span><span class="op">=</span><span class="st">”res2”</span><span class="dt">&gt;</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&lt;</span><span class="kw">span</span><span class="ot"> class</span><span class="op">=</span><span class="st">”sn_auth_name”</span><span class="dt">&gt;</span>Shakespeare<span class="dt">&lt;/</span><span class="kw">span</span><span class="dt">&gt;</span>,</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&lt;</span><span class="kw">span</span><span class="ot"> class</span><span class="op">=</span><span class="st">”sn_auth_firstname”</span><span class="dt">&gt;</span>William<span class="dt">&lt;/</span><span class="kw">span</span><span class="dt">&gt;</span>:</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&lt;</span><span class="kw">span</span><span class="ot"> class</span><span class="op">=</span><span class="st">”sn_target_title”</span><span class="dt">&gt;</span>König Lear: Tragödie<span class="dt">&lt;/</span><span class="kw">span</span><span class="dt">&gt;</span></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>  [<span class="dt">&lt;</span><span class="kw">span</span><span class="ot"> class</span><span class="op">=</span><span class="st">”sn_target_lang”</span><span class="dt">&gt;</span>German<span class="dt">&lt;/</span><span class="kw">span</span><span class="dt">&gt;</span>]</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>  / <span class="dt">&lt;</span><span class="kw">span</span><span class="ot"> class</span><span class="op">=</span><span class="st">”sn_transl_name”</span><span class="dt">&gt;</span>Baudissin<span class="dt">&lt;/</span><span class="kw">span</span><span class="dt">&gt;</span>,</span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&lt;</span><span class="kw">span</span><span class="ot"> class</span><span class="op">=</span><span class="st">”sn_transl_firstname”</span><span class="dt">&gt;</span>Wolf Heinrich<span class="dt">&lt;/</span><span class="kw">span</span><span class="dt">&gt;</span></span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>  / <span class="dt">&lt;</span><span class="kw">span</span><span class="ot"> class</span><span class="op">=</span><span class="st">”sn_pub”</span><span class="dt">&gt;&lt;</span><span class="kw">span</span><span class="ot"> class</span><span class="op">=</span><span class="st">”place”</span><span class="dt">&gt;</span>Stuttgart<span class="dt">&lt;/</span><span class="kw">span</span><span class="dt">&gt;</span>:</span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&lt;</span><span class="kw">span</span><span class="ot"> class</span><span class="op">=</span><span class="st">”publisher”</span><span class="dt">&gt;</span>Reclam<span class="dt">&lt;/</span><span class="kw">span</span><span class="dt">&gt;</span></span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>  [<span class="dt">&lt;</span><span class="kw">span</span><span class="ot"> class</span><span class="op">=</span><span class="st">”sn_country”</span><span class="dt">&gt;</span>Germany<span class="dt">&lt;/</span><span class="kw">span</span><span class="dt">&gt;</span>]<span class="dt">&lt;/</span><span class="kw">span</span><span class="dt">&gt;</span>,</span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&lt;</span><span class="kw">span</span><span class="ot"> class</span><span class="op">=</span><span class="st">”sn_year”</span><span class="dt">&gt;</span>1979<span class="dt">&lt;/</span><span class="kw">span</span><span class="dt">&gt;</span>.</span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&lt;</span><span class="kw">span</span><span class="ot"> class</span><span class="op">=</span><span class="st">”sn_pagination”</span><span class="dt">&gt;</span>112 p.<span class="dt">&lt;/</span><span class="kw">span</span><span class="dt">&gt;</span></span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&lt;</span><span class="kw">span</span><span class="ot"> class</span><span class="op">=</span><span class="st">”sn_orig_title”</span><span class="dt">&gt;</span>King Lear<span class="dt">&lt;/</span><span class="kw">span</span><span class="dt">&gt;</span></span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a>  [<span class="dt">&lt;</span><span class="kw">span</span><span class="ot"> class</span><span class="op">=</span><span class="st">”sn_orig_lang”</span><span class="dt">&gt;</span>English<span class="dt">&lt;/</span><span class="kw">span</span><span class="dt">&gt;</span>]</span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;/</span><span class="kw">td</span><span class="dt">&gt;</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>The IT records come with the following vocabulary:</p>
<ul>
<li><em>place</em>: publication place</li>
<li><em>publisher</em>: publisher</li>
<li><em>sn_auth_name</em>: author’s family name</li>
<li><em>sn_auth_firstname</em>: author’s first name</li>
<li><em>sn_target_title</em>: the title in the target language</li>
<li><em>sn_target_lang</em>: the target language</li>
<li><em>sn_country</em>: country of the publication place</li>
<li><em>sn_year</em>: publication year</li>
<li><em>sn_pagination</em>: pagination</li>
<li><em>sn_orig_lang</em>: original (or source) langue</li>
<li><em>sn_transl_name</em>: translator’s family name</li>
<li><em>sn_transl_firstname</em>: translator’s first name</li>
<li><em>sn_orig_title</em>: title in source languge</li>
<li><em>sn_editionstat</em>: edition statement</li>
<li>_sn_interm_titl_e: title in intermediate language</li>
<li><em>sn_interm_lang</em>: intermediate language</li>
<li><em>sn_isbn</em>: ISBN</li>
<li><em>sn_auth_quality</em>: quality indicator for the author</li>
<li><em>sn_transl_quality</em>: quality indicator for the translator</li>
</ul>
<p>Of course not all data elements are available in every record. IT collected bibliographical records from national libraries, and the quality of them vary a lot. There are character encoding problems, and sometimes falsely tagged data elements.</p>
<p>There are a number of technical possibilities to parse HTML. Since IT’s HTML pages are seemingly transformed from a database with strict rules, one can apply regular expressions, which is a risky approach in lots of other cases. There are more advanced HTML parser libraries however such as <em>BeautifulSoap</em>. Here is the <a href="https://www.crummy.com/software/BeautifulSoup/bs4/doc/">documentation</a>, and Programming Historian also has a tutorial:</p>
<blockquote class="blockquote">
<p>Jeri Wieringa, “Intro to Beautiful Soup,” Programming Historian 1 (2012), <a href="https://doi.org/10.46430/phen0008">https://doi.org/10.46430/phen0008</a></p>
</blockquote>
<p>which unfortunately a ‘retired’ lesson, since the HTML page on which the author demonstrates the strength of the library is no longer available, but still a good introduction, and one can apply the methods on IT.</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="annotated-cell-16"><pre class="sourceCode python code-annotation-code code-with-copy code-annotated"><code class="sourceCode python"><a class="code-annotation-anchor" data-target-cell="annotated-cell-16" data-target-annotation="1" onclick="event.preventDefault();">1</a><span id="annotated-cell-16-1" class="code-annotation-target"><a href="#annotated-cell-16-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> requests</span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-16" data-target-annotation="2" onclick="event.preventDefault();">2</a><span id="annotated-cell-16-2" class="code-annotation-target"><a href="#annotated-cell-16-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> lxml.html</span>
<span id="annotated-cell-16-3"><a href="#annotated-cell-16-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-16" data-target-annotation="3" onclick="event.preventDefault();">3</a><span id="annotated-cell-16-4" class="code-annotation-target"><a href="#annotated-cell-16-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> re</span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-16" data-target-annotation="4" onclick="event.preventDefault();">4</a><span id="annotated-cell-16-5" class="code-annotation-target"><a href="#annotated-cell-16-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> urllib.parse</span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-16" data-target-annotation="5" onclick="event.preventDefault();">5</a><span id="annotated-cell-16-6" class="code-annotation-target"><a href="#annotated-cell-16-6" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> csv</span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-16" data-target-annotation="6" onclick="event.preventDefault();">6</a><span id="annotated-cell-16-7" class="code-annotation-target"><a href="#annotated-cell-16-7" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> collections <span class="im">import</span> Counter</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-16" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-16" data-code-lines="1" data-code-annotation="1">We use another URL handling library: the <a href="https://requests.readthedocs.io/en/latest/">request library</a> that provides more convenient methods for the same task as the urllib package. The request package needs installation with a <code>pip install request</code>.</span>
</dd>
<dt data-target-cell="annotated-cell-16" data-target-annotation="2">2</dt>
<dd>
<span data-code-cell="annotated-cell-16" data-code-lines="2" data-code-annotation="2">Previously we used another module from the <code>lxml</code> library. <code>html</code> provides methods for parsing HTML files.</span>
</dd>
<dt data-target-cell="annotated-cell-16" data-target-annotation="3">3</dt>
<dd>
<span data-code-cell="annotated-cell-16" data-code-lines="4" data-code-annotation="3"><code>re</code> provides regular expression functionalities. As this part of core Python, it doesn’t need installation.</span>
</dd>
<dt data-target-cell="annotated-cell-16" data-target-annotation="4">4</dt>
<dd>
<span data-code-cell="annotated-cell-16" data-code-lines="5" data-code-annotation="4">the <a href="https://docs.python.org/3/library/urllib.parse.html">parse module</a> helps to parse URLs and extract important parameters</span>
</dd>
<dt data-target-cell="annotated-cell-16" data-target-annotation="5">5</dt>
<dd>
<span data-code-cell="annotated-cell-16" data-code-lines="6" data-code-annotation="5">The <a href="https://docs.python.org/3/library/csv.html">csv module</a> helps in reading and writing CSV files.</span>
</dd>
<dt data-target-cell="annotated-cell-16" data-target-annotation="6">6</dt>
<dd>
<span data-code-cell="annotated-cell-16" data-code-lines="7" data-code-annotation="6">Counter, well it is counting things</span>
</dd>
</dl>
<p>We define two variables for our URL requests.</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>base_url <span class="op">=</span> <span class="st">'https://www.unesco.org/xtrans/bsresult.aspx'</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>it_params <span class="op">=</span> {</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">'a'</span>: <span class="st">'Bourdieu, Pierre'</span>,</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">'fr'</span>: <span class="dv">0</span></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p><code>base_url</code> is part of the URL we always use in the requests. To retrieve the second and any following pages of the hit list we should change the rest of the URL, the so-called <em>query</em> part (after the question mark). It is a list of key=value pairs separated by ampersand (<em>&amp;</em>) character. We set up the <code>it_params</code> variable, which represents the URL query. This is a <em>dict</em> data type, and will be automatically transformed to URL during the request.</p>
<p>We should do some more preparation. When we parse HTML pages the process is almost always iterative, because we usually move forward with baby steps adding new and new parts to our script. In practice it means that we fetch the website many times – that might cause problems on the data provider’s web site. A best practice is to be nice to them, and try to eliminate the number of requests by caching: when we first retrieve a page, we should store it locally as a file in our disk, and next time we read it from the disk.</p>
<p>Add a new function to our <code>bsutils</code> module:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>...</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> create_dir(<span class="bu">dir</span>):</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a><span class="co">    Create a directory if it doesn't yet exist</span></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a><span class="co">    :param dir: the directory name</span></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> os.path.exists(<span class="bu">dir</span>):</span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>        os.makedirs(<span class="bu">dir</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>Then we use it in the web scraping script:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="annotated-cell-19"><pre class="sourceCode python code-annotation-code code-with-copy code-annotated"><code class="sourceCode python"><a class="code-annotation-anchor" data-target-cell="annotated-cell-19" data-target-annotation="1" onclick="event.preventDefault();">1</a><span id="annotated-cell-19-1" class="code-annotation-target"><a href="#annotated-cell-19-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> bsutils</span>
<span id="annotated-cell-19-2"><a href="#annotated-cell-19-2" aria-hidden="true" tabindex="-1"></a>...</span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-19" data-target-annotation="2" onclick="event.preventDefault();">2</a><span id="annotated-cell-19-3" class="code-annotation-target"><a href="#annotated-cell-19-3" aria-hidden="true" tabindex="-1"></a>create_dir(<span class="st">'cache'</span>)</span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-19" data-target-annotation="3" onclick="event.preventDefault();">3</a><span id="annotated-cell-19-4" class="code-annotation-target"><a href="#annotated-cell-19-4" aria-hidden="true" tabindex="-1"></a>cache_dir <span class="op">=</span> os.path.join(<span class="st">'cache'</span>, <span class="st">'it'</span>)</span>
<span id="annotated-cell-19-5"><a href="#annotated-cell-19-5" aria-hidden="true" tabindex="-1"></a>create_dir(cache_dir)</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-19" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-19" data-code-lines="1" data-code-annotation="1">imports our module</span>
</dd>
<dt data-target-cell="annotated-cell-19" data-target-annotation="2">2</dt>
<dd>
<span data-code-cell="annotated-cell-19" data-code-lines="3" data-code-annotation="2">creates a directory called ‘cache’</span>
</dd>
<dt data-target-cell="annotated-cell-19" data-target-annotation="3">3</dt>
<dd>
<span data-code-cell="annotated-cell-19" data-code-lines="4" data-code-annotation="3">defines a directory called <code>it</code> inside the <code>cache</code> directory. Different operating systems handle subdirectories differently, <code>os.path.join</code> provides a safe way to use the appropriate syntax.</span>
</dd>
</dl>
<p>We also have to create containers for the data we plan to extract.</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="annotated-cell-20"><pre class="sourceCode python code-annotation-code code-with-copy code-annotated"><code class="sourceCode python"><a class="code-annotation-anchor" data-target-cell="annotated-cell-20" data-target-annotation="1" onclick="event.preventDefault();">1</a><span id="annotated-cell-20-1" class="code-annotation-target"><a href="#annotated-cell-20-1" aria-hidden="true" tabindex="-1"></a>records <span class="op">=</span> []</span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-20" data-target-annotation="2" onclick="event.preventDefault();">2</a><span id="annotated-cell-20-2" class="code-annotation-target"><a href="#annotated-cell-20-2" aria-hidden="true" tabindex="-1"></a>authors <span class="op">=</span> []</span>
<span id="annotated-cell-20-3"><a href="#annotated-cell-20-3" aria-hidden="true" tabindex="-1"></a>translators <span class="op">=</span> []</span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-20" data-target-annotation="3" onclick="event.preventDefault();">3</a><span id="annotated-cell-20-4" class="code-annotation-target"><a href="#annotated-cell-20-4" aria-hidden="true" tabindex="-1"></a>record_counter <span class="op">=</span> <span class="dv">1</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-20" data-target-annotation="4" onclick="event.preventDefault();">4</a><span id="annotated-cell-20-5" class="code-annotation-target"><a href="#annotated-cell-20-5" aria-hidden="true" tabindex="-1"></a>field_names <span class="op">=</span> Counter({})</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-20" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-20" data-code-lines="1" data-code-annotation="1"><code>record</code> (a list of dictionaries) will contain our records.</span>
</dd>
<dt data-target-cell="annotated-cell-20" data-target-annotation="2">2</dt>
<dd>
<span data-code-cell="annotated-cell-20" data-code-lines="2" data-code-annotation="2">as there might be multiple authors, and translators, we collect them separately. Records will have an <code>id</code> field (IT does not provide one), and these two entities will refer to that identifier as the external keys in relational databases.</span>
</dd>
<dt data-target-cell="annotated-cell-20" data-target-annotation="3">3</dt>
<dd>
<span data-code-cell="annotated-cell-20" data-code-lines="4" data-code-annotation="3">record_counter is the source of this identifier. When we process a new record, we will increment this value</span>
</dd>
<dt data-target-cell="annotated-cell-20" data-target-annotation="4">4</dt>
<dd>
<span data-code-cell="annotated-cell-20" data-code-lines="5" data-code-annotation="4">during the development we do not always know each field beforehand. <a href="https://docs.python.org/3/library/collections.html#collections.Counter">Counter</a> is a special Python data type that provides us a method to count things.</span>
</dd>
</dl>
<p>We start the process with the initial values:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>request_page(it_params)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>that triggers the following:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="annotated-cell-22"><pre class="sourceCode python code-annotation-code code-with-copy code-annotated"><code class="sourceCode python"><span id="annotated-cell-22-1"><a href="#annotated-cell-22-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> request_page(it_params):</span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-22" data-target-annotation="1" onclick="event.preventDefault();">1</a><span id="annotated-cell-22-2" class="code-annotation-target"><a href="#annotated-cell-22-2" aria-hidden="true" tabindex="-1"></a>    cache_file <span class="op">=</span> os.path.join(cache_dir, <span class="ss">f'results_</span><span class="sc">{</span>it_params[<span class="st">'fr'</span>]<span class="sc">}</span><span class="ss">.html'</span>)</span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-22" data-target-annotation="2" onclick="event.preventDefault();">2</a><span id="annotated-cell-22-3" class="code-annotation-target"><a href="#annotated-cell-22-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> os.path.exists(cache_file):</span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-22" data-target-annotation="3" onclick="event.preventDefault();">3</a><span id="annotated-cell-22-4" class="code-annotation-target"><a href="#annotated-cell-22-4" aria-hidden="true" tabindex="-1"></a>        <span class="cf">with</span> <span class="bu">open</span>(cache_file, <span class="st">'r'</span>) <span class="im">as</span> f:</span>
<span id="annotated-cell-22-5"><a href="#annotated-cell-22-5" aria-hidden="true" tabindex="-1"></a>            content <span class="op">=</span> f.read()</span>
<span id="annotated-cell-22-6"><a href="#annotated-cell-22-6" aria-hidden="true" tabindex="-1"></a>        process_page(content)</span>
<span id="annotated-cell-22-7"><a href="#annotated-cell-22-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-22" data-target-annotation="4" onclick="event.preventDefault();">4</a><span id="annotated-cell-22-8" class="code-annotation-target"><a href="#annotated-cell-22-8" aria-hidden="true" tabindex="-1"></a>        response <span class="op">=</span> requests.get(base_url, params<span class="op">=</span>it_params)</span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-22" data-target-annotation="5" onclick="event.preventDefault();">5</a><span id="annotated-cell-22-9" class="code-annotation-target"><a href="#annotated-cell-22-9" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> response.status_code <span class="op">==</span> <span class="dv">200</span>:</span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-22" data-target-annotation="6" onclick="event.preventDefault();">6</a><span id="annotated-cell-22-10" class="code-annotation-target"><a href="#annotated-cell-22-10" aria-hidden="true" tabindex="-1"></a>            content <span class="op">=</span> response.text</span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-22" data-target-annotation="7" onclick="event.preventDefault();">7</a><span id="annotated-cell-22-11" class="code-annotation-target"><a href="#annotated-cell-22-11" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> re.search(<span class="st">'The requested URL was rejected.'</span>, content) <span class="kw">is</span> <span class="va">None</span>:</span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-22" data-target-annotation="8" onclick="event.preventDefault();">8</a><span id="annotated-cell-22-12" class="code-annotation-target"><a href="#annotated-cell-22-12" aria-hidden="true" tabindex="-1"></a>                <span class="cf">with</span> <span class="bu">open</span>(cache_file, <span class="st">'wb'</span>) <span class="im">as</span> f:</span>
<span id="annotated-cell-22-13"><a href="#annotated-cell-22-13" aria-hidden="true" tabindex="-1"></a>                    f.write(response.content)</span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-22" data-target-annotation="9" onclick="event.preventDefault();">9</a><span id="annotated-cell-22-14" class="code-annotation-target"><a href="#annotated-cell-22-14" aria-hidden="true" tabindex="-1"></a>            process_page(content)</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-22" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-22" data-code-lines="2" data-code-annotation="1">defines the cache file name out of the current URL’s <code>fr</code> parameter (the offset of the first record in the page from the first record in the hit list).</span>
</dd>
<dt data-target-cell="annotated-cell-22" data-target-annotation="2">2</dt>
<dd>
<span data-code-cell="annotated-cell-22" data-code-lines="3" data-code-annotation="2">checks if the cache file already exists</span>
</dd>
<dt data-target-cell="annotated-cell-22" data-target-annotation="3">3</dt>
<dd>
<span data-code-cell="annotated-cell-22" data-code-lines="4" data-code-annotation="3">if it does, the content should be read from the file, then process it with process_page() method.</span>
</dd>
<dt data-target-cell="annotated-cell-22" data-target-annotation="4">4</dt>
<dd>
<span data-code-cell="annotated-cell-22" data-code-lines="8" data-code-annotation="4">otherwise we should request the page from the IT server</span>
</dd>
<dt data-target-cell="annotated-cell-22" data-target-annotation="5">5</dt>
<dd>
<span data-code-cell="annotated-cell-22" data-code-lines="9" data-code-annotation="5">if it returns with HTTP status code 200 – which means the communication went well</span>
</dd>
<dt data-target-cell="annotated-cell-22" data-target-annotation="6">6</dt>
<dd>
<span data-code-cell="annotated-cell-22" data-code-lines="10" data-code-annotation="6">extracts the content</span>
</dd>
<dt data-target-cell="annotated-cell-22" data-target-annotation="7">7</dt>
<dd>
<span data-code-cell="annotated-cell-22" data-code-lines="11" data-code-annotation="7">however, the IT web server also returns code 200 even though there are some errors, for example if we issue too many requests (which is now prevented by the caching mechanism). During the development we met only one error message. <a href="https://docs.python.org/3/library/re.html#re.search">re.search</a>(pattern, string) returns mathing objects if pattern is found in the string, otherwise it returns None.</span>
</dd>
<dt data-target-cell="annotated-cell-22" data-target-annotation="8">8</dt>
<dd>
<span data-code-cell="annotated-cell-22" data-code-lines="12" data-code-annotation="8">if it doesn’t find the error message, the content will be saved to the cache file.</span>
</dd>
<dt data-target-cell="annotated-cell-22" data-target-annotation="9">9</dt>
<dd>
<span data-code-cell="annotated-cell-22" data-code-lines="14" data-code-annotation="9">processes it with process_page() method.</span>
</dd>
</dl>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="annotated-cell-23"><pre class="sourceCode python code-annotation-code code-with-copy code-annotated"><code class="sourceCode python"><span id="annotated-cell-23-1"><a href="#annotated-cell-23-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> process_page(content):</span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-23" data-target-annotation="1" onclick="event.preventDefault();">1</a><span id="annotated-cell-23-2" class="code-annotation-target"><a href="#annotated-cell-23-2" aria-hidden="true" tabindex="-1"></a>    doc <span class="op">=</span> lxml.html.fromstring(content)</span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-23" data-target-annotation="2" onclick="event.preventDefault();">2</a><span id="annotated-cell-23-3" class="code-annotation-target"><a href="#annotated-cell-23-3" aria-hidden="true" tabindex="-1"></a>    extract_translations(doc)</span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-23" data-target-annotation="3" onclick="event.preventDefault();">3</a><span id="annotated-cell-23-4" class="code-annotation-target"><a href="#annotated-cell-23-4" aria-hidden="true" tabindex="-1"></a>    from_param <span class="op">=</span> extract_next_link(doc)</span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-23" data-target-annotation="4" onclick="event.preventDefault();">4</a><span id="annotated-cell-23-5" class="code-annotation-target"><a href="#annotated-cell-23-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> from_param <span class="op">!=</span> <span class="va">None</span>:</span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-23" data-target-annotation="5" onclick="event.preventDefault();">5</a><span id="annotated-cell-23-6" class="code-annotation-target"><a href="#annotated-cell-23-6" aria-hidden="true" tabindex="-1"></a>        it_params[<span class="st">'fr'</span>] <span class="op">=</span> from_param</span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-23" data-target-annotation="6" onclick="event.preventDefault();">6</a><span id="annotated-cell-23-7" class="code-annotation-target"><a href="#annotated-cell-23-7" aria-hidden="true" tabindex="-1"></a>        request_page(it_params)</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-23" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-23" data-code-lines="2" data-code-annotation="1">the lxml library parses the document into an internal object</span>
</dd>
<dt data-target-cell="annotated-cell-23" data-target-annotation="2">2</dt>
<dd>
<span data-code-cell="annotated-cell-23" data-code-lines="3" data-code-annotation="2">extract_translations() method will use it to extract the records from this object</span>
</dd>
<dt data-target-cell="annotated-cell-23" data-target-annotation="3">3</dt>
<dd>
<span data-code-cell="annotated-cell-23" data-code-lines="4" data-code-annotation="3">extract_next_link() method extracts the above mentioned from (<code>fr</code>) parameter from the “next” link on the page.</span>
</dd>
<dt data-target-cell="annotated-cell-23" data-target-annotation="4">4</dt>
<dd>
<span data-code-cell="annotated-cell-23" data-code-lines="5" data-code-annotation="4">if it is not None</span>
</dd>
<dt data-target-cell="annotated-cell-23" data-target-annotation="5">5</dt>
<dd>
<span data-code-cell="annotated-cell-23" data-code-lines="6" data-code-annotation="5">update the parameter holder</span>
</dd>
<dt data-target-cell="annotated-cell-23" data-target-annotation="6">6</dt>
<dd>
<span data-code-cell="annotated-cell-23" data-code-lines="7" data-code-annotation="6">and call request_page() to process the next page.</span>
</dd>
</dl>
<p>So these two functions call each other until there is a “next” link on the page.</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="annotated-cell-24"><pre class="sourceCode python code-annotation-code code-with-copy code-annotated"><code class="sourceCode python"><span id="annotated-cell-24-1"><a href="#annotated-cell-24-1" aria-hidden="true" tabindex="-1"></a>ef extract_translations(doc):</span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-24" data-target-annotation="1" onclick="event.preventDefault();">1</a><span id="annotated-cell-24-2" class="code-annotation-target"><a href="#annotated-cell-24-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">global</span> record_counter, authors, translators</span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-24" data-target-annotation="2" onclick="event.preventDefault();">2</a><span id="annotated-cell-24-3" class="code-annotation-target"><a href="#annotated-cell-24-3" aria-hidden="true" tabindex="-1"></a>    items <span class="op">=</span> doc.findall(<span class="st">'body/table[@class="restable"]/tr/td[@class="res2"]'</span>, {})</span>
<span id="annotated-cell-24-4"><a href="#annotated-cell-24-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> item <span class="kw">in</span> items:</span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-24" data-target-annotation="3" onclick="event.preventDefault();">3</a><span id="annotated-cell-24-5" class="code-annotation-target"><a href="#annotated-cell-24-5" aria-hidden="true" tabindex="-1"></a>        record <span class="op">=</span> {<span class="st">'id'</span>: record_counter}</span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-24" data-target-annotation="4" onclick="event.preventDefault();">4</a><span id="annotated-cell-24-6" class="code-annotation-target"><a href="#annotated-cell-24-6" aria-hidden="true" tabindex="-1"></a>        spans <span class="op">=</span> item.findall(<span class="st">'span'</span>)</span>
<span id="annotated-cell-24-7"><a href="#annotated-cell-24-7" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> span <span class="kw">in</span> spans:</span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-24" data-target-annotation="5" onclick="event.preventDefault();">5</a><span id="annotated-cell-24-8" class="code-annotation-target"><a href="#annotated-cell-24-8" aria-hidden="true" tabindex="-1"></a>            key <span class="op">=</span> span.get(<span class="st">'class'</span>)</span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-24" data-target-annotation="6" onclick="event.preventDefault();">6</a><span id="annotated-cell-24-9" class="code-annotation-target"><a href="#annotated-cell-24-9" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> key <span class="op">==</span> <span class="st">'sn_pub'</span>:</span>
<span id="annotated-cell-24-10"><a href="#annotated-cell-24-10" aria-hidden="true" tabindex="-1"></a>                subs <span class="op">=</span> span.findall(<span class="st">'span'</span>)</span>
<span id="annotated-cell-24-11"><a href="#annotated-cell-24-11" aria-hidden="true" tabindex="-1"></a>                <span class="cf">for</span> sub <span class="kw">in</span> subs:</span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-24" data-target-annotation="7" onclick="event.preventDefault();">7</a><span id="annotated-cell-24-12" class="code-annotation-target"><a href="#annotated-cell-24-12" aria-hidden="true" tabindex="-1"></a>                    extract_key_value(record, sub)</span>
<span id="annotated-cell-24-13"><a href="#annotated-cell-24-13" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span>:</span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-24" data-target-annotation="8" onclick="event.preventDefault();">8</a><span id="annotated-cell-24-14" class="code-annotation-target"><a href="#annotated-cell-24-14" aria-hidden="true" tabindex="-1"></a>                extract_key_value(record, span)</span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-24" data-target-annotation="9" onclick="event.preventDefault();">9</a><span id="annotated-cell-24-15" class="code-annotation-target"><a href="#annotated-cell-24-15" aria-hidden="true" tabindex="-1"></a>        record, record_authors, record_translators <span class="op">=</span> normalize_record(record)</span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-24" data-target-annotation="10" onclick="event.preventDefault();">10</a><span id="annotated-cell-24-16" class="code-annotation-target"><a href="#annotated-cell-24-16" aria-hidden="true" tabindex="-1"></a>        records.append(record)</span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-24" data-target-annotation="11" onclick="event.preventDefault();">11</a><span id="annotated-cell-24-17" class="code-annotation-target"><a href="#annotated-cell-24-17" aria-hidden="true" tabindex="-1"></a>        authors <span class="op">+=</span> record_authors</span>
<span id="annotated-cell-24-18"><a href="#annotated-cell-24-18" aria-hidden="true" tabindex="-1"></a>        translators <span class="op">+=</span> record_translators</span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-24" data-target-annotation="12" onclick="event.preventDefault();">12</a><span id="annotated-cell-24-19" class="code-annotation-target"><a href="#annotated-cell-24-19" aria-hidden="true" tabindex="-1"></a>        record_counter <span class="op">+=</span> <span class="dv">1</span></span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-24" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-24" data-code-lines="2" data-code-annotation="1">the method uses some global variables, we make it possible with the <code>global</code> keyword</span>
</dd>
<dt data-target-cell="annotated-cell-24" data-target-annotation="2">2</dt>
<dd>
<span data-code-cell="annotated-cell-24" data-code-lines="3" data-code-annotation="2">extracts individual table cells with an XPath expression (explained above). For each HTML snippet…</span>
</dd>
<dt data-target-cell="annotated-cell-24" data-target-annotation="3">3</dt>
<dd>
<span data-code-cell="annotated-cell-24" data-code-lines="5" data-code-annotation="3">creates a dictionary for the record structure, initially only with the identifier</span>
</dd>
<dt data-target-cell="annotated-cell-24" data-target-annotation="4">4</dt>
<dd>
<span data-code-cell="annotated-cell-24" data-code-lines="6" data-code-annotation="4">all the important data elements are in <code>&lt;span&gt;</code> elements, so we have to find extract them (inside the current cell), and iterate over them</span>
</dd>
<dt data-target-cell="annotated-cell-24" data-target-annotation="5">5</dt>
<dd>
<span data-code-cell="annotated-cell-24" data-code-lines="8" data-code-annotation="5">the semantic information is found in the class attribute, so we should save it</span>
</dd>
<dt data-target-cell="annotated-cell-24" data-target-annotation="6">6</dt>
<dd>
<span data-code-cell="annotated-cell-24" data-code-lines="9" data-code-annotation="6">however there is a special span: <code>sn_pub</code> is a container of other spans, and we have to run a second iteration to extract its children</span>
</dd>
<dt data-target-cell="annotated-cell-24" data-target-annotation="7">7</dt>
<dd>
<span data-code-cell="annotated-cell-24" data-code-lines="12" data-code-annotation="7">and 8. at the end we call the extract_key_value() method with the record structure and the current (non complex) span element. It extracts the value and stores it in the record</span>
</dd>
<dt data-target-cell="annotated-cell-24" data-target-annotation="8">8</dt>
<dd>
<span data-code-cell="annotated-cell-24" data-code-lines="14" data-code-annotation="8">ditto</span>
</dd>
<dt data-target-cell="annotated-cell-24" data-target-annotation="9">9</dt>
<dd>
<span data-code-cell="annotated-cell-24" data-code-lines="15" data-code-annotation="9">after processing all spans we should normalize the record with the normalize_record() method. It returns the normalized method, the list of authors, authors and translators</span>
</dd>
<dt data-target-cell="annotated-cell-24" data-target-annotation="10">10</dt>
<dd>
<span data-code-cell="annotated-cell-24" data-code-lines="16" data-code-annotation="10">as record is a single dictionary it can be appended easily to the list of records</span>
</dd>
<dt data-target-cell="annotated-cell-24" data-target-annotation="11">11</dt>
<dd>
<span data-code-cell="annotated-cell-24" data-code-lines="17" data-code-annotation="11">however as authors and translators are list of dictionaries, append() can not be used here, we should concatenate the lists</span>
</dd>
<dt data-target-cell="annotated-cell-24" data-target-annotation="12">12</dt>
<dd>
<span data-code-cell="annotated-cell-24" data-code-lines="19" data-code-annotation="12">increases the record counter by one</span>
</dd>
</dl>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="annotated-cell-25"><pre class="sourceCode python code-annotation-code code-with-copy code-annotated"><code class="sourceCode python"><span id="annotated-cell-25-1"><a href="#annotated-cell-25-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> extract_key_value(record, span):</span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-25" data-target-annotation="1" onclick="event.preventDefault();">1</a><span id="annotated-cell-25-2" class="code-annotation-target"><a href="#annotated-cell-25-2" aria-hidden="true" tabindex="-1"></a>    key <span class="op">=</span> re.sub(<span class="vs">r'</span><span class="dv">^</span><span class="vs">sn_'</span>, <span class="st">''</span>, span.get(<span class="st">'class'</span>))</span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-25" data-target-annotation="2" onclick="event.preventDefault();">2</a><span id="annotated-cell-25-3" class="code-annotation-target"><a href="#annotated-cell-25-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> key <span class="kw">not</span> <span class="kw">in</span> [<span class="st">'auth_name'</span>, <span class="st">'auth_firstname'</span>, <span class="st">'transl_name'</span>, <span class="st">'transl_firstname'</span>]:</span>
<span id="annotated-cell-25-4"><a href="#annotated-cell-25-4" aria-hidden="true" tabindex="-1"></a>        field_names.update([key])</span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-25" data-target-annotation="3" onclick="event.preventDefault();">3</a><span id="annotated-cell-25-5" class="code-annotation-target"><a href="#annotated-cell-25-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> key <span class="kw">not</span> <span class="kw">in</span> record:</span>
<span id="annotated-cell-25-6"><a href="#annotated-cell-25-6" aria-hidden="true" tabindex="-1"></a>        record[key] <span class="op">=</span> []</span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-25" data-target-annotation="4" onclick="event.preventDefault();">4</a><span id="annotated-cell-25-7" class="code-annotation-target"><a href="#annotated-cell-25-7" aria-hidden="true" tabindex="-1"></a>    record[key].append(span.text)</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-25" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-25" data-code-lines="2" data-code-annotation="1">the key of the field is derived from the class attribute, but the ‘sn_’ string from its beginning should be removed with a regular expression. <a href="https://docs.python.org/3/library/re.html#re.sub">re.sub</a> has three mandatory parameters: pattern, replacement and the input string. <code>^</code> is a building block of regular expressions, meaning the beginning of the string, so it will not match same string elsewhere (see the full syntax <a href="https://docs.python.org/3/library/re.html#regular-expression-syntax">here</a>)</span>
</dd>
<dt data-target-cell="annotated-cell-25" data-target-annotation="2">2</dt>
<dd>
<span data-code-cell="annotated-cell-25" data-code-lines="3" data-code-annotation="2">author and translator names will be stored in a distinct table, but we count how many times the rest appear in the pages.</span>
</dd>
<dt data-target-cell="annotated-cell-25" data-target-annotation="3">3</dt>
<dd>
<span data-code-cell="annotated-cell-25" data-code-lines="5" data-code-annotation="3">we expect that each field is repeatable, so if the key is not available in the dictionary, we initialize it as a list</span>
</dd>
<dt data-target-cell="annotated-cell-25" data-target-annotation="4">4</dt>
<dd>
<span data-code-cell="annotated-cell-25" data-code-lines="7" data-code-annotation="4">and append the value (the text attribute of the span) to this list</span>
</dd>
</dl>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="annotated-cell-26"><pre class="sourceCode python code-annotation-code code-with-copy code-annotated"><code class="sourceCode python"><span id="annotated-cell-26-1"><a href="#annotated-cell-26-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> extract_next_link(doc):</span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-26" data-target-annotation="1" onclick="event.preventDefault();">1</a><span id="annotated-cell-26-2" class="code-annotation-target"><a href="#annotated-cell-26-2" aria-hidden="true" tabindex="-1"></a>    <span class="bu">next</span> <span class="op">=</span> doc.findall(<span class="st">'body/table[@class="nav"]/tr[1]/td[@class="next"]/a'</span>, {})</span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-26" data-target-annotation="2" onclick="event.preventDefault();">2</a><span id="annotated-cell-26-3" class="code-annotation-target"><a href="#annotated-cell-26-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">len</span>(<span class="bu">next</span>) <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-26" data-target-annotation="3" onclick="event.preventDefault();">3</a><span id="annotated-cell-26-4" class="code-annotation-target"><a href="#annotated-cell-26-4" aria-hidden="true" tabindex="-1"></a>        link <span class="op">=</span> <span class="bu">next</span>[<span class="dv">0</span>].get(<span class="st">'href'</span>)</span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-26" data-target-annotation="4" onclick="event.preventDefault();">4</a><span id="annotated-cell-26-5" class="code-annotation-target"><a href="#annotated-cell-26-5" aria-hidden="true" tabindex="-1"></a>        parsed_link <span class="op">=</span> urllib.parse.urlparse(link)</span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-26" data-target-annotation="5" onclick="event.preventDefault();">5</a><span id="annotated-cell-26-6" class="code-annotation-target"><a href="#annotated-cell-26-6" aria-hidden="true" tabindex="-1"></a>        parameters <span class="op">=</span> urllib.parse.parse_qs(parsed_link.query)</span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-26" data-target-annotation="6" onclick="event.preventDefault();">6</a><span id="annotated-cell-26-7" class="code-annotation-target"><a href="#annotated-cell-26-7" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="st">'fr'</span> <span class="kw">in</span> parameters <span class="kw">and</span> <span class="bu">len</span>(parameters[<span class="st">'fr'</span>]) <span class="op">==</span> <span class="dv">1</span>:</span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-26" data-target-annotation="7" onclick="event.preventDefault();">7</a><span id="annotated-cell-26-8" class="code-annotation-target"><a href="#annotated-cell-26-8" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> parameters[<span class="st">'fr'</span>][<span class="dv">0</span>]</span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-26" data-target-annotation="8" onclick="event.preventDefault();">8</a><span id="annotated-cell-26-9" class="code-annotation-target"><a href="#annotated-cell-26-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="va">None</span></span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-26" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-26" data-code-lines="2" data-code-annotation="1">extracts the “next” link</span>
</dd>
<dt data-target-cell="annotated-cell-26" data-target-annotation="2">2</dt>
<dd>
<span data-code-cell="annotated-cell-26" data-code-lines="3" data-code-annotation="2">it is not available on the last page, so it should be checked if it is processable</span>
</dd>
<dt data-target-cell="annotated-cell-26" data-target-annotation="3">3</dt>
<dd>
<span data-code-cell="annotated-cell-26" data-code-lines="4" data-code-annotation="3">the <em>fr</em> parameter is available in the href attribute of the first (and only) “next” link</span>
</dd>
<dt data-target-cell="annotated-cell-26" data-target-annotation="4">4</dt>
<dd>
<span data-code-cell="annotated-cell-26" data-code-lines="5" data-code-annotation="4">parses it with the urllib’s <a href="https://docs.python.org/3/library/urllib.parse.html#urllib.parse.urlparse">method</a>, that returns a fixed structure: <a href="https://docs.python.org/3/library/urllib.parse.html#urllib.parse.ParseResult">6-item named tuple</a>.</span>
</dd>
<dt data-target-cell="annotated-cell-26" data-target-annotation="5">5</dt>
<dd>
<span data-code-cell="annotated-cell-26" data-code-lines="6" data-code-annotation="5">its element query contains only a string, which should be parsed with <a href="https://docs.python.org/3/library/urllib.parse.html#urllib.parse.parse_qs">parse_qs</a></span>
</dd>
<dt data-target-cell="annotated-cell-26" data-target-annotation="6">6</dt>
<dd>
<span data-code-cell="annotated-cell-26" data-code-lines="7" data-code-annotation="6">the keys in the query string are repeatable, and parse returns a dictionary. Make sure that the parameters you look for is available and has only one value</span>
</dd>
<dt data-target-cell="annotated-cell-26" data-target-annotation="7">7</dt>
<dd>
<span data-code-cell="annotated-cell-26" data-code-lines="8" data-code-annotation="7">returns the first (and only) fr value</span>
</dd>
<dt data-target-cell="annotated-cell-26" data-target-annotation="8">8</dt>
<dd>
<span data-code-cell="annotated-cell-26" data-code-lines="9" data-code-annotation="8">in every other cases returns a special value: None (not above we had a check on this None)</span>
</dd>
</dl>
<p>As mentioned above there are two things we should improve in the extracted record structure:</p>
<ol type="1">
<li>we would store the author and translators in distinct CSV files (and we will join tables only during data analysis)</li>
<li>the values of the other fields are also lists, however we do not necessary need them as list, and in CSV it is not easy to handle lists in cells</li>
</ol>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="annotated-cell-27"><pre class="sourceCode python code-annotation-code code-with-copy code-annotated"><code class="sourceCode python"><span id="annotated-cell-27-1"><a href="#annotated-cell-27-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> normalize_record(record):</span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-27" data-target-annotation="1" onclick="event.preventDefault();">1</a><span id="annotated-cell-27-2" class="code-annotation-target"><a href="#annotated-cell-27-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> key, value <span class="kw">in</span> record.items():</span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-27" data-target-annotation="2" onclick="event.preventDefault();">2</a><span id="annotated-cell-27-3" class="code-annotation-target"><a href="#annotated-cell-27-3" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> key <span class="kw">not</span> <span class="kw">in</span> [<span class="st">'auth_name'</span>, <span class="st">'auth_firstname'</span>, <span class="st">'transl_name'</span>, <span class="st">'transl_firstname'</span>]:</span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-27" data-target-annotation="3" onclick="event.preventDefault();">3</a><span id="annotated-cell-27-4" class="code-annotation-target"><a href="#annotated-cell-27-4" aria-hidden="true" tabindex="-1"></a>            record[key] <span class="op">=</span> <span class="st">', '</span>.join(value)</span>
<span id="annotated-cell-27-5"><a href="#annotated-cell-27-5" aria-hidden="true" tabindex="-1"></a></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-27" data-target-annotation="4" onclick="event.preventDefault();">4</a><span id="annotated-cell-27-6" class="code-annotation-target"><a href="#annotated-cell-27-6" aria-hidden="true" tabindex="-1"></a>    authors <span class="op">=</span> extract_names(record, <span class="st">'auth_name'</span>, <span class="st">'auth_firstname'</span>)</span>
<span id="annotated-cell-27-7"><a href="#annotated-cell-27-7" aria-hidden="true" tabindex="-1"></a>    translators <span class="op">=</span> extract_names(record, <span class="st">'transl_name'</span>, <span class="st">'transl_firstname'</span>)</span>
<span id="annotated-cell-27-8"><a href="#annotated-cell-27-8" aria-hidden="true" tabindex="-1"></a></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-27" data-target-annotation="5" onclick="event.preventDefault();">5</a><span id="annotated-cell-27-9" class="code-annotation-target"><a href="#annotated-cell-27-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> record, authors, translators</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-27" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-27" data-code-lines="2" data-code-annotation="1">iterates over the key-value pairs of the dictionary</span>
</dd>
<dt data-target-cell="annotated-cell-27" data-target-annotation="2">2</dt>
<dd>
<span data-code-cell="annotated-cell-27" data-code-lines="3" data-code-annotation="2">if the key is not one of the author and translator name related field</span>
</dd>
<dt data-target-cell="annotated-cell-27" data-target-annotation="3">3</dt>
<dd>
<span data-code-cell="annotated-cell-27" data-code-lines="4" data-code-annotation="3">“flatten” it by concatenate the value with comma (and space)</span>
</dd>
<dt data-target-cell="annotated-cell-27" data-target-annotation="4">4</dt>
<dd>
<span data-code-cell="annotated-cell-27" data-code-lines="6" data-code-annotation="4">handles author and translator names with the extract_names() method, that returns the list of authors, and the list of translators</span>
</dd>
<dt data-target-cell="annotated-cell-27" data-target-annotation="5">5</dt>
<dd>
<span data-code-cell="annotated-cell-27" data-code-lines="9" data-code-annotation="5">returns the cleared record, and the two name lists</span>
</dd>
</dl>
<p>The extract_names() method however is not that simple as it seems to be. There are two problems.</p>
<ol type="1">
<li>in HTML we have sequences of last name, first name pairs, while our structure collects all last names and first names in distinct lists</li>
<li>sometimes the first name pair is missing. It would not be the problem if it would be the last element, but there are cases when an ‘et al.’ (as last name) takes place in the middle of the list. Because of this problem we can not use the otherwise handy built-in <a href="https://docs.python.org/3/library/functions.html#zip">zip</a> function, that creates tuples out of the pairs.</li>
</ol>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="annotated-cell-28"><pre class="sourceCode python code-annotation-code code-with-copy code-annotated"><code class="sourceCode python"><span id="annotated-cell-28-1"><a href="#annotated-cell-28-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> extract_names(record, lastname_key, firstname_key):</span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-28" data-target-annotation="1" onclick="event.preventDefault();">1</a><span id="annotated-cell-28-2" class="code-annotation-target"><a href="#annotated-cell-28-2" aria-hidden="true" tabindex="-1"></a>    name_records <span class="op">=</span> []</span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-28" data-target-annotation="2" onclick="event.preventDefault();">2</a><span id="annotated-cell-28-3" class="code-annotation-target"><a href="#annotated-cell-28-3" aria-hidden="true" tabindex="-1"></a>    i <span class="op">=</span> <span class="op">-</span><span class="dv">1</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-28" data-target-annotation="3" onclick="event.preventDefault();">3</a><span id="annotated-cell-28-4" class="code-annotation-target"><a href="#annotated-cell-28-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> lastname_key <span class="kw">in</span> record:</span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-28" data-target-annotation="4" onclick="event.preventDefault();">4</a><span id="annotated-cell-28-5" class="code-annotation-target"><a href="#annotated-cell-28-5" aria-hidden="true" tabindex="-1"></a>        firstnames <span class="op">=</span> record.get(firstname_key, [])</span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-28" data-target-annotation="5" onclick="event.preventDefault();">5</a><span id="annotated-cell-28-6" class="code-annotation-target"><a href="#annotated-cell-28-6" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> name <span class="kw">in</span> record.get(lastname_key):</span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-28" data-target-annotation="6" onclick="event.preventDefault();">6</a><span id="annotated-cell-28-7" class="code-annotation-target"><a href="#annotated-cell-28-7" aria-hidden="true" tabindex="-1"></a>            name_record <span class="op">=</span> {<span class="st">'rid'</span>: record[<span class="st">'id'</span>], <span class="st">'last'</span>: name, <span class="st">'first'</span>: <span class="va">None</span>}</span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-28" data-target-annotation="7" onclick="event.preventDefault();">7</a><span id="annotated-cell-28-8" class="code-annotation-target"><a href="#annotated-cell-28-8" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> name <span class="op">!=</span> <span class="st">'et al.'</span>:</span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-28" data-target-annotation="8" onclick="event.preventDefault();">8</a><span id="annotated-cell-28-9" class="code-annotation-target"><a href="#annotated-cell-28-9" aria-hidden="true" tabindex="-1"></a>                i <span class="op">+=</span> <span class="dv">1</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-28" data-target-annotation="9" onclick="event.preventDefault();">9</a><span id="annotated-cell-28-10" class="code-annotation-target"><a href="#annotated-cell-28-10" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> (<span class="bu">len</span>(firstnames) <span class="op">&gt;</span> i):</span>
<span id="annotated-cell-28-11"><a href="#annotated-cell-28-11" aria-hidden="true" tabindex="-1"></a>                    name_record[<span class="st">'first'</span>] <span class="op">=</span> firstnames[i]</span>
<span id="annotated-cell-28-12"><a href="#annotated-cell-28-12" aria-hidden="true" tabindex="-1"></a>            name_records.append(name_record)</span>
<span id="annotated-cell-28-13"><a href="#annotated-cell-28-13" aria-hidden="true" tabindex="-1"></a></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-28" data-target-annotation="10" onclick="event.preventDefault();">10</a><span id="annotated-cell-28-14" class="code-annotation-target"><a href="#annotated-cell-28-14" aria-hidden="true" tabindex="-1"></a>        <span class="kw">del</span> record[lastname_key]</span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-28" data-target-annotation="11" onclick="event.preventDefault();">11</a><span id="annotated-cell-28-15" class="code-annotation-target"><a href="#annotated-cell-28-15" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">len</span>(firstnames) <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="annotated-cell-28-16"><a href="#annotated-cell-28-16" aria-hidden="true" tabindex="-1"></a>            <span class="kw">del</span> record[firstname_key]</span>
<span id="annotated-cell-28-17"><a href="#annotated-cell-28-17" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="annotated-cell-28-18"><a href="#annotated-cell-28-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> name_records</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-28" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-28" data-code-lines="2" data-code-annotation="1">creates an empty list for the names</span>
</dd>
<dt data-target-cell="annotated-cell-28" data-target-annotation="2">2</dt>
<dd>
<span data-code-cell="annotated-cell-28" data-code-lines="3" data-code-annotation="2">initializes a counter with -1, because 0 is the index of the first element in a list and we will increase it before using it</span>
</dd>
<dt data-target-cell="annotated-cell-28" data-target-annotation="3">3</dt>
<dd>
<span data-code-cell="annotated-cell-28" data-code-lines="4" data-code-annotation="3">sometimes translators are missing from the records, so we check if we should process it at all</span>
</dd>
<dt data-target-cell="annotated-cell-28" data-target-annotation="4">4</dt>
<dd>
<span data-code-cell="annotated-cell-28" data-code-lines="5" data-code-annotation="4">the first name is also missing sometimes, so we get an empty list if this is the case. If we would not add the default parameter, we would retrieve None instead which is not iterable, and raises errors when we check the length later.</span>
</dd>
<dt data-target-cell="annotated-cell-28" data-target-annotation="5">5</dt>
<dd>
<span data-code-cell="annotated-cell-28" data-code-lines="6" data-code-annotation="5">iterates over the last names</span>
</dd>
<dt data-target-cell="annotated-cell-28" data-target-annotation="6">6</dt>
<dd>
<span data-code-cell="annotated-cell-28" data-code-lines="7" data-code-annotation="6">creates a dictionary with None as the default first name that will be updated if there is a real first name</span>
</dd>
<dt data-target-cell="annotated-cell-28" data-target-annotation="7">7</dt>
<dd>
<span data-code-cell="annotated-cell-28" data-code-lines="8" data-code-annotation="7">‘et al.’ does not have first name, so we can skip it</span>
</dd>
<dt data-target-cell="annotated-cell-28" data-target-annotation="8">8</dt>
<dd>
<span data-code-cell="annotated-cell-28" data-code-lines="9" data-code-annotation="8">in every other case it increases our counter</span>
</dd>
<dt data-target-cell="annotated-cell-28" data-target-annotation="9">9</dt>
<dd>
<span data-code-cell="annotated-cell-28" data-code-lines="10" data-code-annotation="9">if there is a corresponding first name by the index it updates the dictionary with that value. At the end of the check the current name will be appended to the list of names.</span>
</dd>
<dt data-target-cell="annotated-cell-28" data-target-annotation="10">10</dt>
<dd>
<span data-code-cell="annotated-cell-28" data-code-lines="14" data-code-annotation="10">as we do not need it any more in the main record structure, we delete the last name</span>
</dd>
<dt data-target-cell="annotated-cell-28" data-target-annotation="11">11</dt>
<dd>
<span data-code-cell="annotated-cell-28" data-code-lines="15" data-code-annotation="11">and the first name as well if it exists at all.</span>
</dd>
</dl>
<p>What remained is to save the extracted data into CSV files:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="annotated-cell-29"><pre class="sourceCode python code-annotation-code code-with-copy code-annotated"><code class="sourceCode python"><span id="annotated-cell-29-1"><a href="#annotated-cell-29-1" aria-hidden="true" tabindex="-1"></a>create_diroutput_dir <span class="op">=</span> os.path.join(<span class="st">'raw-data'</span>, <span class="st">'it'</span>)</span>
<span id="annotated-cell-29-2"><a href="#annotated-cell-29-2" aria-hidden="true" tabindex="-1"></a>create_dir(output_dir)</span>
<span id="annotated-cell-29-3"><a href="#annotated-cell-29-3" aria-hidden="true" tabindex="-1"></a></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-29" data-target-annotation="1" onclick="event.preventDefault();">1</a><span id="annotated-cell-29-4" class="code-annotation-target"><a href="#annotated-cell-29-4" aria-hidden="true" tabindex="-1"></a>output_file <span class="op">=</span> os.path.join(output_dir, <span class="st">'it.csv'</span>)</span>
<span id="annotated-cell-29-5"><a href="#annotated-cell-29-5" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> <span class="bu">open</span>(output_file, <span class="st">'w'</span>, encoding<span class="op">=</span><span class="st">'utf-8'</span>) <span class="im">as</span> csv_file: </span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-29" data-target-annotation="2" onclick="event.preventDefault();">2</a><span id="annotated-cell-29-6" class="code-annotation-target"><a href="#annotated-cell-29-6" aria-hidden="true" tabindex="-1"></a>    column_names <span class="op">=</span> [<span class="st">'id'</span>] <span class="op">+</span> <span class="bu">list</span>(field_names.keys())</span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-29" data-target-annotation="3" onclick="event.preventDefault();">3</a><span id="annotated-cell-29-7" class="code-annotation-target"><a href="#annotated-cell-29-7" aria-hidden="true" tabindex="-1"></a>    output_writer <span class="op">=</span> csv.DictWriter(csv_file, fieldnames<span class="op">=</span>column_names)</span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-29" data-target-annotation="4" onclick="event.preventDefault();">4</a><span id="annotated-cell-29-8" class="code-annotation-target"><a href="#annotated-cell-29-8" aria-hidden="true" tabindex="-1"></a>    output_writer.writeheader()</span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-29" data-target-annotation="5" onclick="event.preventDefault();">5</a><span id="annotated-cell-29-9" class="code-annotation-target"><a href="#annotated-cell-29-9" aria-hidden="true" tabindex="-1"></a>    output_writer.writerows(records)</span>
<span id="annotated-cell-29-10"><a href="#annotated-cell-29-10" aria-hidden="true" tabindex="-1"></a></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-29" data-target-annotation="6" onclick="event.preventDefault();">6</a><span id="annotated-cell-29-11" class="code-annotation-target"><a href="#annotated-cell-29-11" aria-hidden="true" tabindex="-1"></a>column_names<span class="op">=</span>[<span class="st">'rid'</span>, <span class="st">'last'</span>, <span class="st">'first'</span>]</span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-29" data-target-annotation="7" onclick="event.preventDefault();">7</a><span id="annotated-cell-29-12" class="code-annotation-target"><a href="#annotated-cell-29-12" aria-hidden="true" tabindex="-1"></a>names <span class="op">=</span> {<span class="st">'authors.csv'</span>: authors, <span class="st">'translators.csv'</span>: translators}</span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-29" data-target-annotation="8" onclick="event.preventDefault();">8</a><span id="annotated-cell-29-13" class="code-annotation-target"><a href="#annotated-cell-29-13" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> file_name, data <span class="kw">in</span> names.items():</span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-29" data-target-annotation="9" onclick="event.preventDefault();">9</a><span id="annotated-cell-29-14" class="code-annotation-target"><a href="#annotated-cell-29-14" aria-hidden="true" tabindex="-1"></a>    output_file <span class="op">=</span> os.path.join(output_dir, file_name)</span>
<span id="annotated-cell-29-15"><a href="#annotated-cell-29-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> <span class="bu">open</span>(output_file, <span class="st">'w'</span>, encoding<span class="op">=</span><span class="st">'utf-8'</span>) <span class="im">as</span> csv_file:</span>
<span id="annotated-cell-29-16"><a href="#annotated-cell-29-16" aria-hidden="true" tabindex="-1"></a>        output_writer <span class="op">=</span> csv.DictWriter(csv_file, fieldnames<span class="op">=</span>column_names)</span>
<span id="annotated-cell-29-17"><a href="#annotated-cell-29-17" aria-hidden="true" tabindex="-1"></a>        output_writer.writeheader()</span>
<span id="annotated-cell-29-18"><a href="#annotated-cell-29-18" aria-hidden="true" tabindex="-1"></a>        output_writer.writerows(data)</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-29" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-29" data-code-lines="4" data-code-annotation="1">opens a CSV file raw-data/it/it.csv using the safe os.path.join function</span>
</dd>
<dt data-target-cell="annotated-cell-29" data-target-annotation="2">2</dt>
<dd>
<span data-code-cell="annotated-cell-29" data-code-lines="6" data-code-annotation="2">the column names are ‘id’ and the names we extracted from the class attributes</span>
</dd>
<dt data-target-cell="annotated-cell-29" data-target-annotation="3">3</dt>
<dd>
<span data-code-cell="annotated-cell-29" data-code-lines="7" data-code-annotation="3">CSV writer’s API is similar to other file writers in Python. The csv library provides a number of functions, here we use the <a href="https://docs.python.org/3/library/csv.html#csv.DictWriter">DictWriter</a> that allows us to turn the list of dictionaries to CSV. It has two mandatory parameters: the file handler and the list of field names. All keys in the dictionaries should be available in the field name list, however they might be missing values in the records. E.g. if “location” is a key in the record dictionary, the field name list must contain it, but not every record should have the “location” key.</span>
</dd>
<dt data-target-cell="annotated-cell-29" data-target-annotation="4">4</dt>
<dd>
<span data-code-cell="annotated-cell-29" data-code-lines="8" data-code-annotation="4">writes out the header line to the CSV file</span>
</dd>
<dt data-target-cell="annotated-cell-29" data-target-annotation="5">5</dt>
<dd>
<span data-code-cell="annotated-cell-29" data-code-lines="9" data-code-annotation="5">writes out the individual records</span>
</dd>
<dt data-target-cell="annotated-cell-29" data-target-annotation="6">6</dt>
<dd>
<span data-code-cell="annotated-cell-29" data-code-lines="11" data-code-annotation="6">repeats the same process for authors and translators, but here we give a fixed field name list, and not extract it from the HTML.</span>
</dd>
<dt data-target-cell="annotated-cell-29" data-target-annotation="7">7</dt>
<dd>
<span data-code-cell="annotated-cell-29" data-code-lines="12" data-code-annotation="7">creates a dictionary for enabling the iteration. Its keys will be used as file names and the values are the name lists.</span>
</dd>
<dt data-target-cell="annotated-cell-29" data-target-annotation="8">8</dt>
<dd>
<span data-code-cell="annotated-cell-29" data-code-lines="13" data-code-annotation="8">items() on a dictionary iterates over its key-value pairs – we can name them anyhow.</span>
</dd>
<dt data-target-cell="annotated-cell-29" data-target-annotation="9">9</dt>
<dd>
<span data-code-cell="annotated-cell-29" data-code-lines="14" data-code-annotation="9">the rest is very similar to the first CSV writing process.</span>
</dd>
</dl>
<p>The full script is available in the repository as scripts/ch3a-web-scraping.py. The Intra-Belgian literary translations since 1970 (<a href="https://www.kbr.be/en/projects/beltrans/">BELTRANS</a>) project of <a href="https://kbr.be">KBR</a> (the Belgian National Library) provides a more elaborated approach to the same problem in their <a href="https://github.com/kbrbe/beltrans-data-integration/tree/main/data-sources/unesco">Github repository</a> – thanks to Sven Lieber for the pointer.</p>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
      const outerScaffold = trigger.parentElement.cloneNode(true);
      const codeEl = outerScaffold.querySelector('code');
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="./ch2b.html" class="pagination-link" aria-label="Cultural heritage data models">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Cultural heritage data models</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./ch3b.html" class="pagination-link" aria-label="data validation">
        <span class="nav-page-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">data validation</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->




</body></html>